{"version":3,"sources":["setup.js","clonsola/clonsola.js","linea-de-tiempo-selector.js","linea-de-tiempo.js","mapa-a-barras.js","mapa-a-cartograma.js","nube-de-palabras.js","main.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;ACLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnmCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7/BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACt6BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrwCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"aplicacion.js","sourcesContent":["/*\r\nEl sitio donde se usaron las visualizaciones usa otra versión de jQuery, así que se guarda la referencia en otra variable global\r\n*/\r\n\"use strict\";\r\nvar jQuery_3_3_1 = $.noConflict(true);\r\n","/*\r\nEnvía clones de objetos a la consola en vez del estado actual de los mismos\r\n*/\r\nvar clonsola = (function() {\r\n  function log(obj) {\r\n    console.log(_.cloneDeep(obj));\r\n  }\r\n\r\n  function dir(obj) {\r\n    console.dir(_.cloneDeep(obj));\r\n  }\r\n\r\n  function warn(obj) {\r\n    console.warn(_.cloneDeep(obj));\r\n  }\r\n\r\n  function error(obj) {\r\n    console.error(_.cloneDeep(obj));\r\n  }\r\n\r\n  function clear() {\r\n    console.clear();\r\n  }\r\n  return {\r\n    log: log,\r\n    dir: dir,\r\n    warn: warn,\r\n    error: error,\r\n    clear: clear\r\n  };\r\n})();\r\n","var LineaDeTiempoSelector = function($, el, flagIniciar) {\r\n  flagIniciar = flagIniciar || false;\r\n  var flagEsp =\r\n    window.location.pathname.split(\"/\").indexOf(\"eng\") >= 0 ? false : true;\r\n\r\n  var estados = null;\r\n  var candidatos = null;\r\n  var valores = null;\r\n\r\n  var estiloLeyenda = {\r\n    \"font-family\": \"'Roboto', sans-serif\",\r\n    \"font-size\": \"11px\",\r\n    \"font-style\": \"normal\",\r\n    \"text-anchor\": \"middle\",\r\n    \"alignment-baseline\": \"central\",\r\n    \"text-transform\": \"uppercase\",\r\n    \"font-kerning\": \"normal\"\r\n  };\r\n\r\n  var estiloPeriodo = {\r\n    \"font-family\": \"'Roboto', sans-serif\",\r\n    \"font-size\": \"18px\",\r\n    \"font-style\": \"normal\",\r\n    \"text-anchor\": \"middle\",\r\n    \"alignment-baseline\": \"central\",\r\n    \"text-transform\": \"uppercase\",\r\n    \"font-kerning\": \"normal\"\r\n  };\r\n\r\n  var estiloLineas = { fill: \"none\", \"stroke-width\": \"3px\" };\r\n\r\n  var margin = { top: 20, right: 20, bottom: 20, left: 20 };\r\n  var medidas = {\r\n    ancho: 800 - margin.left - margin.right,\r\n    alto: 800 - margin.top - margin.bottom\r\n  };\r\n\r\n  var tarjeta = { ancho: 86, alto: 92 };\r\n  var offsetTarjeta = 9;\r\n  var retrato = { ancho: 70, alto: 70 };\r\n  var medidasMarcador = { ancho: 42, alto: 42 };\r\n\r\n  var contenedor = null;\r\n  var svg = null;\r\n  var gReticula = null;\r\n  var gLineas = null;\r\n  var gCirculos = null;\r\n  var gLeyenda = null;\r\n  var gSlider = null;\r\n\r\n  var linea = null;\r\n\r\n  var periodoTexto = null;\r\n\r\n  var idSombra = getGUID();\r\n  var idGris = getGUID();\r\n\r\n  var escalaX = d3.time.scale().range([0, medidas.ancho - 130]);\r\n  var escalaY = d3.scale\r\n    .linear()\r\n    .range([medidas.alto - 170, 120])\r\n    .domain([0, 100]);\r\n\r\n  var anchoMarcador = 101;\r\n  var inicioMedida = 22.5;\r\n  var anchoMedida = 707;\r\n  var medida = null;\r\n  var marcador = null;\r\n\r\n  var conversionEscalaX = d3.scale\r\n    .linear()\r\n    .domain([0, anchoMedida - anchoMarcador])\r\n    .range([0, medidas.ancho - 130])\r\n    .clamp([true]);\r\n\r\n  var offsetMarcador = false;\r\n\r\n  var posicion = 0;\r\n  var tramoEscalaY = d3.scale.linear().clamp([true]);\r\n\r\n  function setup(el) {\r\n    var elemento = null;\r\n    var flag = null;\r\n    contenedor = d3.select(el);\r\n    elemento = contenedor.node() || false;\r\n    if (elemento !== false) {\r\n      flag = contenedor.attr(\"data-visualizacion\") || false;\r\n      if (flag === false) {\r\n        contenedor.attr(\"data-visualizacion\", \"true\");\r\n        contenedor.classed(\"espera\", true);\r\n        contenedor.selectAll(\"svg\").remove();\r\n\r\n        svg = contenedor\r\n          .append(\"svg\")\r\n          .attr(\"preserveAspectRatio\", \"xMidYMid\")\r\n          .attr(\r\n            \"viewBox\",\r\n            \"0 0 \" +\r\n              (medidas.ancho + margin.left + margin.right) +\r\n              \" \" +\r\n              (medidas.alto + margin.top + margin.bottom)\r\n          );\r\n\r\n        var defs = svg.append(\"defs\");\r\n        var filter = defs\r\n          .append(\"filter\")\r\n          .attr(\"id\", idSombra)\r\n          .attr(\"height\", \"130%\");\r\n\r\n        filter\r\n          .append(\"feGaussianBlur\")\r\n          .attr(\"in\", \"SourceAlpha\")\r\n          .attr(\"stdDeviation\", \"2\");\r\n\r\n        filter\r\n          .append(\"feOffset\")\r\n          .attr(\"dx\", \"2\")\r\n          .attr(\"dy\", \"2\")\r\n          .attr(\"result\", \"offsetblur\");\r\n\r\n        filter\r\n          .append(\"feFlood\")\r\n          .attr(\"flood-color\", \"rgb(0,0,0)\")\r\n          .attr(\"flood-opacity\", \"0.2\");\r\n\r\n        filter\r\n          .append(\"feComposite\")\r\n          .attr(\"in2\", \"offsetblur\")\r\n          .attr(\"operator\", \"in\");\r\n\r\n        var feMerge = filter.append(\"feMerge\");\r\n        feMerge.append(\"feMergeNode\");\r\n        feMerge.append(\"feMergeNode\").attr(\"in\", \"SourceGraphic\");\r\n\r\n        defs\r\n          .append(\"filter\")\r\n          .attr(\"id\", idGris)\r\n          .append(\"feColorMatrix\")\r\n          .attr(\"type\", \"matrix\")\r\n          .attr(\r\n            \"values\",\r\n            \"0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\"\r\n          );\r\n\r\n        svg\r\n          .append(\"rect\")\r\n          .attr(\"fill\", \"#ffffff\")\r\n          .attr(\"x\", 0)\r\n          .attr(\"y\", 0)\r\n          .attr(\"width\", medidas.ancho + margin.left + margin.right)\r\n          .attr(\"height\", medidas.alto + margin.top + margin.bottom);\r\n\r\n        svg = svg\r\n          .append(\"g\")\r\n          .attr(\r\n            \"transform\",\r\n            \"translate(\" + margin.left + \",\" + margin.top + \")\"\r\n          );\r\n        svg\r\n          .append(\"rect\")\r\n          .attr(\"width\", medidas.ancho + (margin.right - margin.left))\r\n          .attr(\"height\", medidas.alto)\r\n          .attr(\"fill\", \"#ffffff\");\r\n\r\n        gReticula = svg.append(\"g\");\r\n        gReticula\r\n          .append(\"rect\")\r\n          .attr(\"x\", 0)\r\n          .attr(\"y\", 112)\r\n          .attr(\"width\", medidas.ancho)\r\n          .attr(\"height\", 505)\r\n          .attr(\"fill\", \"#ffffff\")\r\n          .style(\"filter\", \"url(#\" + idSombra + \")\");\r\n\r\n        gLineas = svg.append(\"g\");\r\n        gCirculos = svg.append(\"g\");\r\n\r\n        periodoTexto = svg\r\n          .append(\"g\")\r\n          .attr(\"transform\", \"translate(0,682)\")\r\n          .append(\"text\")\r\n          .attr(\"x\", medidas.ancho / 2)\r\n          .style(estiloPeriodo);\r\n\r\n        gLeyenda = svg.append(\"g\");\r\n\r\n        gSlider = svg\r\n          .append(\"g\")\r\n          .attr(\"transform\", \"translate(0,\" + (medidas.alto - 60) + \")\");\r\n\r\n        linea = d3.svg\r\n          .line()\r\n          .x(function(d) {\r\n            return escalaX(d.fecha);\r\n          })\r\n          .y(function(d) {\r\n            return escalaY(d.valor);\r\n          });\r\n\r\n        var descarga = $(elemento)\r\n          .closest(\"div.visualizacion\")\r\n          .next()\r\n          .next()\r\n          .find(\"img[alt=download]\")\r\n          .closest(\"a\");\r\n        if (descarga.length === 0) {\r\n          descarga = $(elemento)\r\n            .closest(\"div.visualizacion\")\r\n            .closest(\"section\")\r\n            .find(\"img[alt=download]\")\r\n            .closest(\"a\");\r\n        }\r\n        if (descarga.length !== 0) {\r\n          descarga.attr(\"href\", \"#\").click(function(event) {\r\n            event.preventDefault();\r\n            event.stopPropagation();\r\n            descargaVisualizacion(elemento);\r\n          });\r\n        }\r\n\r\n        main();\r\n      }\r\n    }\r\n  }\r\n\r\n  function generaEjes() {\r\n    _.each(estados, function(es) {\r\n      _.each(es.candidatos, function(candidato, clave) {\r\n        _.each(candidato.puntos, function(punto) {\r\n          var arreglo = punto.fecha.split(\"-\");\r\n          var anio = parseInt(arreglo[0]);\r\n          var mes = parseInt(arreglo[1]) - 1;\r\n          if (arreglo.length === 3) {\r\n            var dia = parseInt(arreglo[2]);\r\n            punto.fecha = new Date(anio, mes, dia);\r\n          } else {\r\n            punto.fecha = new Date(anio, mes);\r\n          }\r\n        });\r\n      });\r\n    });\r\n\r\n    var fechas = _.map(\r\n      _.flatten(_.map(_.flatten(candidatos), \"puntos\")),\r\n      \"fecha\"\r\n    );\r\n\r\n    escalaX.domain(d3.extent(fechas));\r\n\r\n    _.each(estados, function(es) {\r\n      _.each(es.candidatos, function(candidato) {\r\n        _.map(candidato.puntos, function(p) {\r\n          p.x = escalaX(p.fecha);\r\n        });\r\n        var r = _.clone(candidato.puntos);\r\n        _.reverse(r);\r\n        candidato.rpuntos = r;\r\n      });\r\n    });\r\n  }\r\n\r\n  function generaLeyenda() {\r\n    var ancho =\r\n      tarjeta.ancho * candidatos.length +\r\n      offsetTarjeta * (candidatos.length - 1);\r\n    var offsetX = (medidas.ancho - ancho) / 2;\r\n    gLeyenda.attr(\"transform\", \"translate(\" + offsetX + \",0)\");\r\n\r\n    var grupos = gLeyenda.selectAll(\"g\").data(candidatos, function(d) {\r\n      return d.gid;\r\n    });\r\n\r\n    grupos.exit().remove();\r\n\r\n    grupos\r\n      .enter()\r\n      .append(\"g\")\r\n      .attr(\"fill\", function(d) {\r\n        return d.color;\r\n      })\r\n      .attr(\"transform\", function(d, i) {\r\n        return \"translate(\" + i * (tarjeta.ancho + offsetTarjeta) + \",0)\";\r\n      })\r\n      .style(\"opacity\", function(d) {\r\n        return d.seleccionado === true ? 1 : 0.3;\r\n      });\r\n\r\n    grupos\r\n      .append(\"rect\")\r\n      .attr(\"x\", 0)\r\n      .attr(\"y\", 0)\r\n      .attr(\"class\", \"cursor\")\r\n      .attr(\"width\", tarjeta.ancho)\r\n      .attr(\"height\", tarjeta.alto)\r\n      .attr(\"fill\", \"#ffffff\")\r\n      .style(\"filter\", \"url(#\" + idSombra + \")\")\r\n      .on(\"click\", toggleCandidato);\r\n\r\n    grupos\r\n      .append(\"svg:image\")\r\n      .attr(\"class\", \"cursor\")\r\n      .attr(\"x\", (tarjeta.ancho - retrato.ancho) / 2)\r\n      .attr(\"y\", 2)\r\n      .attr(\"width\", retrato.ancho)\r\n      .attr(\"height\", retrato.alto)\r\n      .attr(\"xlink:href\", function(d) {\r\n        return d.imgb64;\r\n      })\r\n      .attr(\"fill\", \"transparent\")\r\n      .on(\"click\", toggleCandidato);\r\n\r\n    grupos\r\n      .append(\"text\")\r\n      .text(function(d) {\r\n        return d.nombrecorto;\r\n      })\r\n      .style(\"stroke\", function(d) {\r\n        return d.color;\r\n      })\r\n      .style(\"fill\", function(d) {\r\n        return d.color;\r\n      })\r\n      .style(estiloLeyenda)\r\n      .attr(\"x\", tarjeta.ancho / 2)\r\n      .attr(\"y\", retrato.alto + 12);\r\n  }\r\n\r\n  function toggleCandidato(d) {\r\n    d.seleccionado = !d.seleccionado;\r\n    gLeyenda\r\n      .selectAll(\"g\")\r\n      .filter(function(g) {\r\n        return g.id === d.id;\r\n      })\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"opacity\", function(g) {\r\n        return g.seleccionado === true ? 1 : 0.3;\r\n      })\r\n      .call(endall, candidatosAGris);\r\n\r\n    gLeyenda\r\n      .selectAll(\"text\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"stroke\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      })\r\n      .style(\"fill\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      });\r\n\r\n    gLineas\r\n      .selectAll(\"g\")\r\n      .filter(function(g) {\r\n        return g.id === d.id;\r\n      })\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"opacity\", function(g) {\r\n        return g.seleccionado === true ? 1 : 0;\r\n      });\r\n\r\n    gLineas\r\n      .selectAll(\"path\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"stroke\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      });\r\n\r\n    gLineas\r\n      .selectAll(\"text\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"stroke\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      })\r\n      .style(\"fill\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      });\r\n\r\n    gCirculos.selectAll(\"circle\").classed(\"ignorar\", function(d) {\r\n      return !d.candidato.seleccionado;\r\n    });\r\n    actualizaTooltips();\r\n  }\r\n\r\n  function generaLineas() {\r\n    var arreglo = [];\r\n    _.each(candidatos, function(c) {\r\n      arreglo.push(c);\r\n    });\r\n    arreglo.sort(function(a, b) {\r\n      var objA = _.last(a.puntos);\r\n      var objB = _.last(b.puntos);\r\n      if (objA.valor < objB.valor) {\r\n        return -1;\r\n      }\r\n      if (objA.valor > objB.valor) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n\r\n    var marcadores = [];\r\n    _.each(arreglo, function(candidato) {\r\n      var filtrados = _.filter(valores, function(v) {\r\n        return v.candidato.id === candidato.id;\r\n      });\r\n      marcadores.push(filtrados);\r\n    });\r\n\r\n    var grupos = gLineas.selectAll(\"g\").data(arreglo, function(d) {\r\n      return d.gid;\r\n    });\r\n\r\n    grupos.exit().remove();\r\n\r\n    grupos\r\n      .enter()\r\n      .append(\"g\")\r\n      .attr(\"fill\", function(d) {\r\n        return d.color;\r\n      })\r\n      .style(\"stroke\", function(d) {\r\n        return d.color;\r\n      });\r\n\r\n    grupos\r\n      .append(\"path\")\r\n      .attr(\"d\", function(d) {\r\n        return linea(d.puntos);\r\n      })\r\n      .each(function(d) {\r\n        d.linea = {};\r\n        d.linea.largo = d3\r\n          .select(this)\r\n          .node()\r\n          .getTotalLength();\r\n        d.linea.parcial = 0;\r\n      })\r\n      .style(estiloLineas)\r\n      .attr(\"stroke-dasharray\", \"0,1\");\r\n\r\n    grupos.append(\"g\");\r\n\r\n    grupos\r\n      .append(\"svg:image\")\r\n      .attr(\"class\", \"ignorar\")\r\n      .attr(\"width\", medidasMarcador.ancho)\r\n      .attr(\"height\", medidasMarcador.alto)\r\n      .attr(\"x\", function(d) {\r\n        return escalaX(d.puntos[0].fecha) + 25;\r\n      })\r\n      .attr(\"y\", function(d) {\r\n        return escalaY(d.puntos[0].valor);\r\n      })\r\n      .attr(\"xlink:href\", function(d) {\r\n        return d.imgb64;\r\n      })\r\n      .attr(\r\n        \"transform\",\r\n        \"translate(\" +\r\n          -medidasMarcador.ancho / 2 +\r\n          \",\" +\r\n          -medidasMarcador.alto / 2 +\r\n          \")\"\r\n      );\r\n\r\n    grupos\r\n      .append(\"text\")\r\n      .text(function(d) {\r\n        return d.nombrecorto;\r\n      })\r\n      .style(\"font-family\", \"'Roboto', sans-serif\")\r\n      .attr(\"x\", function(d) {\r\n        return escalaX(d.puntos[0].fecha) + 25;\r\n      })\r\n      .attr(\"y\", function(d) {\r\n        return escalaY(d.puntos[0].valor) + 5;\r\n      });\r\n\r\n    grupos.selectAll(\"g\").each(function(d) {\r\n      var vs = _.filter(valores, function(v) {\r\n        return v.candidato.id === d.id;\r\n      });\r\n      d3.select(this)\r\n        .selectAll(\"circle\")\r\n        .data(vs)\r\n        .enter()\r\n        .append(\"circle\")\r\n        .attr(\"class\", \"remover\")\r\n        .attr(\"fill\", d.color)\r\n        .attr(\"cx\", function(d) {\r\n          d.x = escalaX(d.fecha);\r\n          return d.x;\r\n        })\r\n        .attr(\"cy\", function(d) {\r\n          return d.y || 625;\r\n        })\r\n        .attr(\"r\", 4)\r\n        .on(\"mouseenter\", function(d) {\r\n          d3.select(this)\r\n            .transition()\r\n            .duration(400)\r\n            .attr(\"r\", 12);\r\n        })\r\n        .on(\"mouseleave\", function(d) {\r\n          d3.select(this)\r\n            .transition()\r\n            .duration(400)\r\n            .attr(\"r\", 4);\r\n        });\r\n    });\r\n\r\n    _.each(arreglo, function(candidato) {\r\n      candidato.tramos = [];\r\n      var n = candidato.puntos.length;\r\n      var i = 0;\r\n      var acumulado = 0;\r\n      for (i = 1; i < n; i++) {\r\n        var xIni = escalaX(candidato.puntos[i - 1].fecha);\r\n        var yIni = escalaY(candidato.puntos[i - 1].valor);\r\n        var xFin = escalaX(candidato.puntos[i].fecha);\r\n        var yFin = escalaY(candidato.puntos[i].valor);\r\n        candidato.tramos.push({\r\n          inicio: [xIni, yIni],\r\n          final: [xFin, yFin],\r\n          acumulado: acumulado\r\n        });\r\n        acumulado += Math.sqrt(\r\n          Math.pow(xFin - xIni, 2) + Math.pow(yFin - yIni, 2)\r\n        );\r\n      }\r\n    });\r\n  }\r\n\r\n  function generaTooltips() {\r\n    var opciones = {\r\n      trigger: \"custom\",\r\n      triggerOpen: {\r\n        mouseenter: true,\r\n        touchstart: true\r\n      },\r\n      triggerClose: {\r\n        mouseleave: true,\r\n        tap: true\r\n      },\r\n      contentAsHTML: true\r\n    };\r\n    gLineas.selectAll(\"circle\").each(function(d) {\r\n      var contenido = \"<p>\" + getCadenaFecha(d) + \"</p>\";\r\n      contenido += \"<ul>\";\r\n      _.each(d.candidatos, function(candidato) {\r\n        contenido +=\r\n          \"<li style='color:\" +\r\n          candidato.color +\r\n          \"'><span class='valor'>\" +\r\n          _.padStart(_.round(candidato.valor), 2, \"0\") +\r\n          \"</span> \" +\r\n          candidato.nombre +\r\n          \"</li>\";\r\n      });\r\n      contenido += \"</ul>\";\r\n      opciones.content = $(contenido);\r\n      opciones.theme = \"tooltipster-shadow\";\r\n      $(this).tooltipster(opciones);\r\n    });\r\n  }\r\n\r\n  function actualizaTooltips() {\r\n    var seleccionados = _.filter(candidatos, { seleccionado: true });\r\n    var ids = _.map(seleccionados, \"id\");\r\n    gLineas.selectAll(\"circle\").each(function(d) {\r\n      var contenido = \"<p>\" + getCadenaFecha(d) + \"</p>\";\r\n      if (ids.length > 0) {\r\n        contenido += \"<ul>\";\r\n        var candidatos = _.filter(d.candidatos, function(d) {\r\n          return ids.indexOf(d.id) >= 0;\r\n        });\r\n        _.each(candidatos, function(candidato) {\r\n          contenido +=\r\n            \"<li style='color:\" +\r\n            candidato.color +\r\n            \"'><span class='valor'>\" +\r\n            _.padStart(_.round(candidato.valor), 2, \"0\") +\r\n            \"</span> \" +\r\n            candidato.nombre +\r\n            \"</li>\";\r\n        });\r\n        contenido += \"</ul>\";\r\n      }\r\n\r\n      $(this).tooltipster(\"content\", contenido);\r\n    });\r\n  }\r\n\r\n  function getCadenaFecha(obj, mes) {\r\n    if (flagEsp) {\r\n      var meses = {\r\n        1: \"Ene\",\r\n        2: \"Feb\",\r\n        3: \"Mar\",\r\n        4: \"Abr\",\r\n        5: \"May\",\r\n        6: \"Jun\",\r\n        7: \"Jul\",\r\n        8: \"Ago\",\r\n        9: \"Sep\",\r\n        10: \"Oct\",\r\n        11: \"Nov\",\r\n        12: \"Dic\"\r\n      };\r\n    } else {\r\n      var meses = {\r\n        1: \"Jan\",\r\n        2: \"Feb\",\r\n        3: \"Mar\",\r\n        4: \"Apr\",\r\n        5: \"May\",\r\n        6: \"Jun\",\r\n        7: \"Jul\",\r\n        8: \"Aug\",\r\n        9: \"Sep\",\r\n        10: \"Oct\",\r\n        11: \"Nov\",\r\n        12: \"Dec\"\r\n      };\r\n    }\r\n    var cadena = null;\r\n    var arreglo = obj.fechatextual.split(\"-\");\r\n    var anio = parseInt(arreglo[0]);\r\n    var mes = parseInt(arreglo[1]);\r\n    if (arreglo.length === 3) {\r\n      var dia = parseInt(arreglo[2]);\r\n      cadena = dia + \" \" + meses[mes] + \" \" + anio;\r\n    }\r\n    if (arreglo.length === 2) {\r\n      cadena = meses[mes] + \" \" + anio;\r\n    }\r\n    return cadena;\r\n  }\r\n\r\n  function generaCSV() {\r\n    var BOM = \"\\uFEFF\";\r\n    var div = $(contenedor.node()).closest(\"div.visualizacion\");\r\n    var liga = div.find(\".descargacsv\");\r\n    var archivo = [];\r\n    var linea = [];\r\n    var datos = {};\r\n    var fechas = _.map(\r\n      _.flatten(_.map(_.flatten(candidatos), \"puntos\")),\r\n      \"fechatextual\"\r\n    );\r\n    _.each(fechas, function(fecha) {\r\n      datos[fecha] = { fecha: fecha, valores: [] };\r\n    });\r\n    linea.push(\"Fecha\");\r\n    _.each(candidatos, function(candidato) {\r\n      linea.push('\"' + candidato.nombre + '\"');\r\n      _.each(candidato.puntos, function(punto) {\r\n        datos[punto.fechatextual].valores.push(punto.celda);\r\n      });\r\n    });\r\n    archivo.push(linea.join(\",\"));\r\n\r\n    datos = _.values(datos);\r\n    datos.sort(function(a, b) {\r\n      if (a.fecha < b.fecha) {\r\n        return -1;\r\n      }\r\n      if (a.fecha > b.fecha) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n\r\n    _.each(datos, function(dato) {\r\n      linea = [];\r\n      linea.push('\"' + dato.fecha + '\"');\r\n      linea = linea.concat(dato.valores);\r\n      archivo.push(linea.join(\",\"));\r\n    });\r\n\r\n    var cadena = archivo.join(\"\\r\\n\");\r\n    liga.attr(\r\n      \"href\",\r\n      \"data:text/csv;charset=utf-8,\" + encodeURIComponent(BOM + cadena)\r\n    );\r\n  }\r\n\r\n  function main() {\r\n    var q = d3.queue();\r\n    var urlValoresJSON = contenedor.attr(\"data-valores\") || false;\r\n    var sToggle = contenedor.attr(\"data-toggle\") || false;\r\n    if (urlValoresJSON !== false) {\r\n      q.defer(d3.json, urlValoresJSON + \"?\" + getGUID());\r\n      q.awaitAll(function(error, arreglo) {\r\n        var qsec = d3.queue();\r\n        estados = arreglo[0];\r\n\r\n        _.each(estados, function(es) {\r\n          es.seleccionado = false;\r\n          _.each(es.candidatos, function(c) {\r\n            if (c.gid === \"\") {\r\n              c.gid = getGUID();\r\n            }\r\n          });\r\n          qsec.defer(d3.json, es.url + \"?\" + getGUID());\r\n        });\r\n        qsec.awaitAll(function(error, arreglo) {\r\n          var arregloObj = [];\r\n          _.each(estados, function(es, i) {\r\n            var temas = arreglo[i].result.aggregated.topics;\r\n            var resultados = arreglo[i].result.aggregated.result;\r\n            es.obj = {};\r\n            es.candidatos.sort(function(a, b) {\r\n              if (a.nombrecorto < b.nombrecorto) {\r\n                return -1;\r\n              }\r\n              if (a.nombrecorto > b.nombrecorto) {\r\n                return 1;\r\n              }\r\n              return 0;\r\n            });\r\n            _.each(es.candidatos, function(candidato) {\r\n              candidato.seleccionado = true;\r\n              candidato.puntos = [];\r\n              var j = _.findIndex(temas, { id: candidato.gid });\r\n              if (j >= 0) {\r\n                candidato.puntos = _.map(resultados, function(r) {\r\n                  return {\r\n                    fecha: r.time,\r\n                    fechatextual: r.time,\r\n                    valor: +r.value[j],\r\n                    celda: r.value[j]\r\n                  };\r\n                });\r\n              } else {\r\n                candidato.puntos = _.map(resultados, function(r) {\r\n                  return {\r\n                    fecha: r.time,\r\n                    fechatextual: r.time,\r\n                    valor: 0,\r\n                    celda: 0\r\n                  };\r\n                });\r\n              }\r\n            });\r\n\r\n            _.each(es.candidatos, function(candidato) {\r\n              _.each(candidato.puntos, function(punto) {\r\n                if (!es.obj.hasOwnProperty(punto.fechatextual)) {\r\n                  es.obj[punto.fechatextual] = {\r\n                    fecha: punto.fechatextual,\r\n                    candidatos: []\r\n                  };\r\n                }\r\n                es.obj[punto.fechatextual].candidatos.push({\r\n                  nombre: candidato.nombre,\r\n                  nombrecorto: candidato.nombrecorto,\r\n                  color: candidato.color,\r\n                  valor: punto.celda,\r\n                  id: candidato.id\r\n                });\r\n              });\r\n            });\r\n\r\n            es.valores = [];\r\n            var arregloInt = _.values(es.obj);\r\n            _.each(arregloInt, function(obj) {\r\n              var fecha = null;\r\n              var fechatextual = obj.fecha;\r\n              var arrf = obj.fecha.split(\"-\");\r\n              var anio = parseInt(arrf[0]);\r\n              var mes = parseInt(arrf[1]) - 1;\r\n              if (arrf.length === 3) {\r\n                var dia = parseInt(arrf[2]);\r\n                fecha = new Date(anio, mes, dia);\r\n              } else {\r\n                fecha = new Date(anio, mes);\r\n              }\r\n              var cands = obj.candidatos;\r\n              _.each(obj.candidatos, function(candidato) {\r\n                var y = escalaY(+candidato.valor || 0);\r\n                es.valores.push({\r\n                  fecha: fecha,\r\n                  fechatextual: fechatextual,\r\n                  y: y,\r\n                  candidatos: cands,\r\n                  candidato: _.find(obj.candidatos, { id: candidato.id })\r\n                });\r\n              });\r\n            });\r\n          });\r\n          estados[0].seleccionado = true;\r\n          candidatos = estados[0].candidatos;\r\n          valores = estados[0].valores;\r\n          if (sToggle !== false) {\r\n            sToggle = $(\"#\" + sToggle);\r\n            sToggle.on(\"change\", cambiaEstado);\r\n            generaToggle(sToggle);\r\n          }\r\n          var f = d3.queue();\r\n          _.each(estados, function(es) {\r\n            _.each(es.candidatos, function(candidato) {\r\n              f.defer(convertImgToBase64URL, candidato);\r\n            });\r\n          });\r\n          f.awaitAll(function(error, a) {\r\n            generaEjes();\r\n            generaLeyenda();\r\n            generaLineas();\r\n            generaSliderTemporal();\r\n            ajustaMarcador(0);\r\n            generaTooltips();\r\n            contenedor.classed(\"espera\", false);\r\n            if (flagIniciar === true) {\r\n              iniciar();\r\n            }\r\n          });\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  function iniciar() {\r\n    marcador\r\n      .transition()\r\n      .duration(4000)\r\n      .attrTween(\"x\", function(d) {\r\n        var i = d3.interpolateNumber(\r\n          _.floor(inicioMedida),\r\n          _.ceil(anchoMedida - anchoMarcador + inicioMedida)\r\n        );\r\n        return function(t) {\r\n          ajustaMarcador(i(t));\r\n          return i(t);\r\n        };\r\n      });\r\n  }\r\n\r\n  function cambiaEstado(ev) {\r\n    var estado = $(ev.target).val();\r\n    _.each(estados, function(e) {\r\n      e.seleccionado = e.estado === estado ? true : false;\r\n      if (e.seleccionado === true) {\r\n        candidatos = e.candidatos;\r\n        valores = e.valores;\r\n        var fechas = _.map(\r\n          _.flatten(_.map(_.flatten(candidatos), \"puntos\")),\r\n          \"fecha\"\r\n        );\r\n        escalaX.domain(d3.extent(fechas));\r\n      }\r\n    });\r\n    generaLeyenda();\r\n    generaLineas();\r\n    generaTooltips();\r\n    iniciar();\r\n  }\r\n\r\n  function generaToggle(el) {\r\n    var arreglo = [];\r\n    _.each(estados, function(e) {\r\n      arreglo.push({ etiqueta: e.nombreestado, valor: e.estado });\r\n    });\r\n    _.each(arreglo, function(o) {\r\n      el.append($(\"<option>\", { value: o.valor, text: o.etiqueta }));\r\n    });\r\n  }\r\n\r\n  function getGUID() {\r\n    return (\r\n      Date.now().toString(36) +\r\n      Math.random()\r\n        .toString(36)\r\n        .substr(2, 5)\r\n    ).toUpperCase();\r\n  }\r\n\r\n  function endall(transition, callback) {\r\n    var n = 0;\r\n    transition\r\n      .each(function() {\r\n        ++n;\r\n      })\r\n      .each(\"end\", function() {\r\n        if (!--n) callback.apply(this, arguments);\r\n      });\r\n  }\r\n\r\n  function candidatosAGris() {\r\n    gLeyenda\r\n      .selectAll(\"image\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"filter\", function(d, i) {\r\n        return d.seleccionado === true ? \"\" : \"url(#\" + idGris + \")\";\r\n      });\r\n\r\n    gLineas\r\n      .selectAll(\"image\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"filter\", function(d, i) {\r\n        return d.seleccionado === true ? \"\" : \"url(#\" + idGris + \")\";\r\n      });\r\n  }\r\n\r\n  function generaSliderTemporal() {\r\n    var drag = d3.behavior\r\n      .drag()\r\n      .on(\"dragstart\", dragstarted)\r\n      .on(\"drag\", dragged)\r\n      .on(\"dragend\", dragended);\r\n\r\n    var fondo = gSlider\r\n      .append(\"rect\")\r\n      .attr(\"fill\", \"white\")\r\n      .attr(\"x\", 0)\r\n      .attr(\"y\", 0)\r\n      .attr(\"width\", 760)\r\n      .attr(\"height\", 60)\r\n      .style(\"filter\", \"url(#\" + idSombra + \")\");\r\n\r\n    var medidaCompleta = gSlider\r\n      .append(\"rect\")\r\n      .attr(\"fill\", \"#cdcdcd\")\r\n      .attr(\"x\", inicioMedida)\r\n      .attr(\"y\", 20)\r\n      .attr(\"width\", anchoMedida)\r\n      .attr(\"height\", 20);\r\n\r\n    medida = gSlider.append(\"rect\");\r\n    medida\r\n      .attr(\"fill\", \"grey\")\r\n      .attr(\"x\", inicioMedida)\r\n      .attr(\"y\", 20)\r\n      .attr(\"width\", anchoMarcador / 2)\r\n      .attr(\"height\", 20)\r\n      .attr(\"class\", \"ignorar\");\r\n\r\n    marcador = gSlider.append(\"rect\");\r\n    marcador\r\n      .attr(\"fill\", \"#000000\")\r\n      .attr(\"x\", inicioMedida)\r\n      .attr(\"y\", 10)\r\n      .attr(\"rx\", 10)\r\n      .attr(\"ry\", 10)\r\n      .attr(\"width\", 101)\r\n      .attr(\"height\", 40)\r\n      .attr(\"class\", \"arrastrar marcador\")\r\n      .call(drag);\r\n  }\r\n\r\n  function dragstarted() {\r\n    d3.event.sourceEvent.stopPropagation();\r\n    offsetMarcador = false;\r\n    d3.select(this).attr(\"class\", \"arrastrando marcador\");\r\n  }\r\n\r\n  function dragged() {\r\n    var x = d3.event.x;\r\n    ajustaMarcador(x);\r\n  }\r\n\r\n  function dragended() {\r\n    offsetMarcador = false;\r\n    d3.select(this).attr(\"class\", \"arrastrar marcador\");\r\n  }\r\n\r\n  function ajustaMarcador(x) {\r\n    if (offsetMarcador === false) {\r\n      offsetMarcador = x - +marcador.attr(\"x\");\r\n    }\r\n    var nx = x - offsetMarcador;\r\n    nx = nx <= inicioMedida ? inicioMedida : nx;\r\n    nx =\r\n      nx >= anchoMedida + inicioMedida - anchoMarcador\r\n        ? anchoMedida + inicioMedida - anchoMarcador\r\n        : nx;\r\n    posicion = nx - inicioMedida;\r\n\r\n    var xLineas = conversionEscalaX(posicion);\r\n\r\n    medida.attr(\"width\", nx - inicioMedida + anchoMarcador / 2);\r\n    marcador.attr(\"x\", nx);\r\n\r\n    gLineas\r\n      .selectAll(\"image\")\r\n      .each(function(d) {\r\n        d.punto = {};\r\n        d.tramo =\r\n          _.find(d.tramos, function(tramo) {\r\n            return tramo.inicio[0] <= xLineas && xLineas <= tramo.final[0];\r\n          }) || false;\r\n        tramoEscalaY\r\n          .domain([d.tramo.inicio[0], d.tramo.final[0]])\r\n          .range([d.tramo.inicio[1], d.tramo.final[1]]);\r\n        d.punto.x = xLineas;\r\n        d.punto.y = tramoEscalaY(xLineas);\r\n\r\n        var punto =\r\n          _.find(d.rpuntos, function(p) {\r\n            return p.x <= xLineas;\r\n          }) || false;\r\n        var texto = getCadenaFecha(punto, \"short\");\r\n        periodoTexto.text(texto);\r\n      })\r\n      .attr(\"x\", function(d) {\r\n        return d.punto.x;\r\n      })\r\n      .attr(\"y\", function(d) {\r\n        return d.punto.y;\r\n      });\r\n\r\n    gLineas\r\n      .selectAll(\"text\")\r\n      .attr(\"x\", xLineas + 25)\r\n      .attr(\"y\", function(d) {\r\n        return d.punto.y;\r\n      });\r\n\r\n    gLineas\r\n      .selectAll(\"circle\")\r\n      .attr(\"opacity\", function(d) {\r\n        return d.x > xLineas ? 0 : 1;\r\n      })\r\n      .style(\"display\", function(d) {\r\n        return d.x > xLineas ? \"none\" : \"\";\r\n      });\r\n\r\n    gLineas.selectAll(\"path\").call(transicionLinea);\r\n  }\r\n\r\n  function transicionLinea(path) {\r\n    path\r\n      .transition()\r\n      .duration(0)\r\n      .attrTween(\"stroke-dasharray\", function(d) {\r\n        var path = d3.select(this);\r\n        d.linea.parcial =\r\n          d.tramo.acumulado +\r\n          Math.sqrt(\r\n            Math.pow(d.punto.x - d.tramo.inicio[0], 2) +\r\n              Math.pow(d.punto.y - d.tramo.inicio[1], 2)\r\n          );\r\n        var path = d3.select(this);\r\n        var l = d.linea.parcial;\r\n        if (d.linea.parcial > d.linea.largo) {\r\n          d.linea.parcial = d.linea.largo;\r\n        }\r\n        if (l === 0) {\r\n          var i = d3.interpolateString(\"0,\" + 0, 0 + \",\" + 1);\r\n        } else {\r\n          var i = d3.interpolateString(\"0,\" + l, l + \",\" + 1000 * l);\r\n        }\r\n        return function(t) {\r\n          var p = path.node().getPointAtLength(t * l);\r\n          return i(t);\r\n        };\r\n      });\r\n  }\r\n\r\n  function descargaVisualizacion(elemento) {\r\n    var el = $(elemento).closest(\"div.visualizacion\");\r\n    var padre = d3\r\n      .select(el[0])\r\n      .node()\r\n      .cloneNode(true);\r\n    padre = d3.select(padre);\r\n    var svg = padre.select(\"svg\");\r\n    var nombreSVG = \"trendlecciones.svg\";\r\n    var nombrePNG = \"trendlecciones-linea-de-tiempo-selector.png\";\r\n    svg.attr(\"height\", medidas.alto + margin.top + margin.bottom);\r\n    svg.attr(\"width\", medidas.ancho + margin.left + margin.right);\r\n    var html = svg\r\n      .attr(\"title\", \"Trendlecciones\")\r\n      .attr(\"version\", 1.1)\r\n      .attr(\"xmlns\", \"http://www.w3.org/2000/svg\")\r\n      .attr(\"xmlns:xlink\", \"http://www.w3.org/1999/xlink\")\r\n      .node().parentNode.innerHTML;\r\n    html = unescape(encodeURIComponent(html));\r\n    var contenidoSVG = btoa(html);\r\n    var imageArtefacto = new Image();\r\n    imageArtefacto.width = medidas.ancho + margin.left + margin.right;\r\n    imageArtefacto.height = medidas.alto + margin.top + margin.bottom;\r\n    imageArtefacto.onload = function() {\r\n      var canvasArtefacto = document.createElement(\"canvas\");\r\n      canvasArtefacto.width = imageArtefacto.width;\r\n      canvasArtefacto.height = imageArtefacto.height;\r\n      canvasArtefacto.getContext(\"2d\").drawImage(imageArtefacto, 0, 0);\r\n      var contenidoPNG = canvasArtefacto.toDataURL(\"image/png\");\r\n      download(contenidoPNG, nombrePNG, \"image/png\");\r\n    };\r\n    imageArtefacto.src = \"data:image/svg+xml;base64,\" + contenidoSVG;\r\n  }\r\n\r\n  function convertImgToBase64URL(d, callback) {\r\n    var img = new Image();\r\n    //img.crossOrigin = \"Anonymous\";\r\n    img.onload = function() {\r\n      var canvas = document.createElement(\"CANVAS\"),\r\n        ctx = canvas.getContext(\"2d\"),\r\n        dataURL;\r\n      canvas.height = img.height;\r\n      canvas.width = img.width;\r\n      ctx.drawImage(img, 0, 0);\r\n      dataURL = canvas.toDataURL(\"image/png\");\r\n      d.imgb64 = dataURL;\r\n      canvas = null;\r\n      callback(null, d);\r\n    };\r\n    d.img = \"img/candidatos/\" + d.img;\r\n    img.src = d.img;\r\n  }\r\n\r\n  setup(el);\r\n\r\n  return { iniciar: iniciar };\r\n};\r\n","var LineaDeTiempo = function($, el, flagIniciar) {\r\n  flagIniciar = flagIniciar || false;\r\n  var flagEsp =\r\n    window.location.pathname.split(\"/\").indexOf(\"eng\") >= 0 ? false : true;\r\n\r\n  var candidatos = null;\r\n  var valores = null;\r\n\r\n  var estiloLeyenda = {\r\n    \"font-family\": \"'Roboto', sans-serif\",\r\n    \"font-size\": \"18px\",\r\n    \"font-style\": \"normal\",\r\n    \"text-anchor\": \"middle\",\r\n    \"alignment-baseline\": \"central\",\r\n    \"text-transform\": \"uppercase\",\r\n    \"font-kerning\": \"normal\"\r\n  };\r\n\r\n  var estiloPeriodo = {\r\n    \"font-family\": \"'Roboto', sans-serif\",\r\n    \"font-size\": \"18px\",\r\n    \"font-style\": \"normal\",\r\n    \"text-anchor\": \"middle\",\r\n    \"alignment-baseline\": \"central\",\r\n    \"text-transform\": \"uppercase\",\r\n    \"font-kerning\": \"normal\"\r\n  };\r\n\r\n  var estiloLineas = { fill: \"none\", \"stroke-width\": \"3px\" };\r\n\r\n  var margin = { top: 20, right: 20, bottom: 20, left: 20 };\r\n  var medidas = {\r\n    ancho: 800 - margin.left - margin.right,\r\n    alto: 800 - margin.top - margin.bottom\r\n  };\r\n\r\n  var tarjeta = { ancho: 133, alto: 124 };\r\n  var offsetTarjeta = 24;\r\n  var retrato = { ancho: 85, alto: 85 };\r\n  var medidasMarcador = { ancho: 42, alto: 42 };\r\n\r\n  var contenedor = null;\r\n  var svg = null;\r\n  var gReticula = null;\r\n  var gLineas = null;\r\n  var gCirculos = null;\r\n  var gLeyenda = null;\r\n  var gSlider = null;\r\n\r\n  var linea = null;\r\n\r\n  var periodoTexto = null;\r\n\r\n  var idSombra = getGUID();\r\n  var idGris = getGUID();\r\n\r\n  var escalaX = d3.time.scale().range([0, medidas.ancho - 100]);\r\n  var escalaY = d3.scale\r\n    .linear()\r\n    .range([medidas.alto - 135, 150])\r\n    .domain([0, 100]);\r\n\r\n  var anchoMarcador = 101;\r\n  var inicioMedida = 22.5;\r\n  var anchoMedida = 707;\r\n  var medida = null;\r\n  var marcador = null;\r\n\r\n  var conversionEscalaX = d3.scale\r\n    .linear()\r\n    .domain([0, anchoMedida - anchoMarcador])\r\n    .range([0, medidas.ancho - 100])\r\n    .clamp([true]);\r\n\r\n  var offsetMarcador = false;\r\n\r\n  var posicion = 0;\r\n  var tramoEscalaY = d3.scale.linear().clamp([true]);\r\n\r\n  function setup(el) {\r\n    var elemento = null;\r\n    var flag = null;\r\n    contenedor = d3.select(el);\r\n    elemento = contenedor.node() || false;\r\n    if (elemento !== false) {\r\n      flag = contenedor.attr(\"data-visualizacion\") || false;\r\n      if (flag === false) {\r\n        contenedor.attr(\"data-visualizacion\", \"true\");\r\n        contenedor.classed(\"espera\", true);\r\n        contenedor.selectAll(\"svg\").remove();\r\n        svg = contenedor\r\n          .append(\"svg\")\r\n          .attr(\"preserveAspectRatio\", \"xMidYMid\")\r\n          .attr(\r\n            \"viewBox\",\r\n            \"0 0 \" +\r\n              (medidas.ancho + margin.left + margin.right) +\r\n              \" \" +\r\n              (medidas.alto + margin.top + margin.bottom)\r\n          );\r\n\r\n        var defs = svg.append(\"defs\");\r\n        var filter = defs\r\n          .append(\"filter\")\r\n          .attr(\"id\", idSombra)\r\n          .attr(\"height\", \"130%\");\r\n\r\n        filter\r\n          .append(\"feGaussianBlur\")\r\n          .attr(\"in\", \"SourceAlpha\")\r\n          .attr(\"stdDeviation\", \"2\");\r\n\r\n        filter\r\n          .append(\"feOffset\")\r\n          .attr(\"dx\", \"2\")\r\n          .attr(\"dy\", \"2\")\r\n          .attr(\"result\", \"offsetblur\");\r\n\r\n        filter\r\n          .append(\"feFlood\")\r\n          .attr(\"flood-color\", \"rgb(0,0,0)\")\r\n          .attr(\"flood-opacity\", \"0.2\");\r\n\r\n        filter\r\n          .append(\"feComposite\")\r\n          .attr(\"in2\", \"offsetblur\")\r\n          .attr(\"operator\", \"in\");\r\n\r\n        var feMerge = filter.append(\"feMerge\");\r\n        feMerge.append(\"feMergeNode\");\r\n        feMerge.append(\"feMergeNode\").attr(\"in\", \"SourceGraphic\");\r\n\r\n        defs\r\n          .append(\"filter\")\r\n          .attr(\"id\", idGris)\r\n          .append(\"feColorMatrix\")\r\n          .attr(\"type\", \"matrix\")\r\n          .attr(\r\n            \"values\",\r\n            \"0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\"\r\n          );\r\n\r\n        svg\r\n          .append(\"rect\")\r\n          .attr(\"fill\", \"#ffffff\")\r\n          .attr(\"x\", 0)\r\n          .attr(\"y\", 0)\r\n          .attr(\"width\", medidas.ancho + margin.left + margin.right)\r\n          .attr(\"height\", medidas.alto + margin.top + margin.bottom);\r\n\r\n        svg = svg\r\n          .append(\"g\")\r\n          .attr(\r\n            \"transform\",\r\n            \"translate(\" + margin.left + \",\" + margin.top + \")\"\r\n          );\r\n        svg\r\n          .append(\"rect\")\r\n          .attr(\"width\", medidas.ancho + (margin.right - margin.left))\r\n          .attr(\"height\", medidas.alto)\r\n          .attr(\"fill\", \"#ffffff\");\r\n\r\n        gReticula = svg.append(\"g\");\r\n        gReticula\r\n          .append(\"rect\")\r\n          .attr(\"x\", 0)\r\n          .attr(\"y\", 145)\r\n          .attr(\"width\", medidas.ancho)\r\n          .attr(\"height\", 505)\r\n          .attr(\"fill\", \"#ffffff\")\r\n          .style(\"filter\", \"url(#\" + idSombra + \")\");\r\n\r\n        gLineas = svg.append(\"g\");\r\n\r\n        gCirculos = svg.append(\"g\");\r\n\r\n        periodoTexto = svg\r\n          .append(\"g\")\r\n          .attr(\"transform\", \"translate(0,682)\")\r\n          .append(\"text\")\r\n          .attr(\"x\", medidas.ancho / 2)\r\n          .style(estiloPeriodo);\r\n        gLeyenda = svg.append(\"g\");\r\n\r\n        gSlider = svg\r\n          .append(\"g\")\r\n          .attr(\"transform\", \"translate(0,\" + (medidas.alto - 60) + \")\");\r\n\r\n        linea = d3.svg\r\n          .line()\r\n          .x(function(d) {\r\n            return escalaX(d.fecha);\r\n          })\r\n          .y(function(d) {\r\n            return escalaY(d.valor);\r\n          });\r\n\r\n        var descarga = $(elemento)\r\n          .closest(\"div.visualizacion\")\r\n          .next()\r\n          .next()\r\n          .find(\"img[alt=download]\")\r\n          .closest(\"a\");\r\n        if (descarga.length === 0) {\r\n          descarga = $(elemento)\r\n            .closest(\"div.visualizacion\")\r\n            .closest(\"section\")\r\n            .find(\"img[alt=download]\")\r\n            .closest(\"a\");\r\n        }\r\n        if (descarga.length !== 0) {\r\n          descarga.attr(\"href\", \"#\").click(function(event) {\r\n            event.preventDefault();\r\n            event.stopPropagation();\r\n            descargaVisualizacion(elemento);\r\n          });\r\n        }\r\n        main();\r\n      }\r\n    }\r\n  }\r\n\r\n  function generaEjes() {\r\n    _.each(candidatos, function(candidato, clave) {\r\n      _.each(candidato.puntos, function(punto) {\r\n        var arreglo = punto.fecha.split(\"-\");\r\n        var anio = parseInt(arreglo[0]);\r\n        var mes = parseInt(arreglo[1]) - 1;\r\n        if (arreglo.length === 3) {\r\n          var dia = parseInt(arreglo[2]);\r\n          punto.fecha = new Date(anio, mes, dia);\r\n        } else {\r\n          punto.fecha = new Date(anio, mes);\r\n        }\r\n      });\r\n    });\r\n    var fechas = _.map(\r\n      _.flatten(_.map(_.flatten(candidatos), \"puntos\")),\r\n      \"fecha\"\r\n    );\r\n\r\n    escalaX.domain(d3.extent(fechas));\r\n\r\n    _.each(candidatos, function(candidato) {\r\n      _.map(candidato.puntos, function(p) {\r\n        p.x = escalaX(p.fecha);\r\n      });\r\n      var r = _.clone(candidato.puntos);\r\n      _.reverse(r);\r\n      candidato.rpuntos = r;\r\n    });\r\n  }\r\n\r\n  function generaLeyenda() {\r\n    var ancho =\r\n      tarjeta.ancho * candidatos.length +\r\n      offsetTarjeta * (candidatos.length - 1);\r\n    var offsetX = (medidas.ancho - ancho) / 2;\r\n    gLeyenda.attr(\"transform\", \"translate(\" + offsetX + \",0)\");\r\n\r\n    var grupos = gLeyenda\r\n      .selectAll(\"g\")\r\n      .data(candidatos)\r\n      .enter()\r\n      .append(\"g\")\r\n      .attr(\"fill\", function(d) {\r\n        return d.color;\r\n      })\r\n      .attr(\"transform\", function(d, i) {\r\n        return \"translate(\" + i * (tarjeta.ancho + offsetTarjeta) + \",0)\";\r\n      });\r\n\r\n    grupos\r\n      .append(\"rect\")\r\n      .attr(\"x\", 0)\r\n      .attr(\"y\", 0)\r\n      .attr(\"class\", \"cursor\")\r\n      .attr(\"width\", tarjeta.ancho)\r\n      .attr(\"height\", tarjeta.alto)\r\n      .attr(\"fill\", \"#ffffff\")\r\n      .style(\"filter\", \"url(#\" + idSombra + \")\")\r\n      .on(\"click\", toggleCandidato);\r\n\r\n    grupos\r\n      .append(\"svg:image\")\r\n      .attr(\"class\", \"cursor\")\r\n      .attr(\"x\", (tarjeta.ancho - retrato.ancho) / 2)\r\n      .attr(\"y\", 10)\r\n      .attr(\"width\", retrato.ancho)\r\n      .attr(\"height\", retrato.alto)\r\n      .attr(\"xlink:href\", function(d) {\r\n        return d.imgb64;\r\n      })\r\n      .attr(\"fill\", \"transparent\")\r\n      .on(\"click\", toggleCandidato);\r\n\r\n    grupos\r\n      .append(\"text\")\r\n      .text(function(d) {\r\n        return d.nombrecorto;\r\n      })\r\n      .style(\"font-family\", \"'Roboto', sans-serif\")\r\n      .style(\"stroke\", function(d) {\r\n        return d.color;\r\n      })\r\n      .style(\"fill\", function(d) {\r\n        return d.color;\r\n      })\r\n      .style(estiloLeyenda)\r\n      .attr(\"x\", tarjeta.ancho / 2)\r\n      .attr(\"y\", retrato.alto + 30);\r\n  }\r\n\r\n  function toggleCandidato(d) {\r\n    d.seleccionado = !d.seleccionado;\r\n    gLeyenda\r\n      .selectAll(\"g\")\r\n      .filter(function(g) {\r\n        return g.id === d.id;\r\n      })\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"opacity\", function(g) {\r\n        return g.seleccionado === true ? 1 : 0.3;\r\n      })\r\n      .call(endall, candidatosAGris);\r\n\r\n    gLeyenda\r\n      .selectAll(\"text\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"stroke\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      })\r\n      .style(\"fill\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      });\r\n\r\n    gLineas\r\n      .selectAll(\"g\")\r\n      .filter(function(g) {\r\n        return g.id === d.id;\r\n      })\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"opacity\", function(g) {\r\n        return g.seleccionado === true ? 1 : 0;\r\n      });\r\n\r\n    gLineas\r\n      .selectAll(\"path\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"stroke\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      });\r\n\r\n    gLineas\r\n      .selectAll(\"text\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"stroke\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      })\r\n      .style(\"fill\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      });\r\n\r\n    gCirculos.selectAll(\"circle\").classed(\"ignorar\", function(d) {\r\n      return !d.candidato.seleccionado;\r\n    });\r\n    actualizaTooltips();\r\n  }\r\n\r\n  function generaLineas() {\r\n    var arreglo = [];\r\n    _.each(candidatos, function(c) {\r\n      arreglo.push(c);\r\n    });\r\n    arreglo.sort(function(a, b) {\r\n      var objA = _.last(a.puntos);\r\n      var objB = _.last(b.puntos);\r\n      if (objA.valor < objB.valor) {\r\n        return -1;\r\n      }\r\n      if (objA.valor > objB.valor) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n\r\n    var marcadores = [];\r\n    _.each(arreglo, function(candidato) {\r\n      var filtrados = _.filter(valores, function(v) {\r\n        return v.candidato.id === candidato.id;\r\n      });\r\n      marcadores.push(filtrados);\r\n    });\r\n\r\n    var grupos = gLineas\r\n      .selectAll(\"g\")\r\n      .data(arreglo)\r\n      .enter()\r\n      .append(\"g\")\r\n      .attr(\"fill\", function(d) {\r\n        return d.color;\r\n      })\r\n      .style(\"stroke\", function(d) {\r\n        return d.color;\r\n      });\r\n\r\n    grupos\r\n      .append(\"path\")\r\n      .attr(\"d\", function(d) {\r\n        return linea(d.puntos);\r\n      })\r\n      .each(function(d) {\r\n        d.linea = {};\r\n        d.linea.largo = d3\r\n          .select(this)\r\n          .node()\r\n          .getTotalLength();\r\n        d.linea.parcial = 0;\r\n      })\r\n      .style(estiloLineas)\r\n      .attr(\"stroke-dasharray\", \"0,1\");\r\n\r\n    grupos.append(\"g\");\r\n\r\n    grupos\r\n      .append(\"svg:image\")\r\n      .attr(\"class\", \"ignorar\")\r\n      .attr(\"width\", medidasMarcador.ancho)\r\n      .attr(\"height\", medidasMarcador.alto)\r\n      .attr(\"x\", function(d) {\r\n        return escalaX(d.puntos[0].fecha);\r\n      })\r\n      .attr(\"y\", function(d) {\r\n        return escalaY(d.puntos[0].valor);\r\n      })\r\n      .attr(\"xlink:href\", function(d) {\r\n        return d.imgb64;\r\n      })\r\n      .attr(\r\n        \"transform\",\r\n        \"translate(\" +\r\n          -medidasMarcador.ancho / 2 +\r\n          \",\" +\r\n          -medidasMarcador.alto / 2 +\r\n          \")\"\r\n      );\r\n\r\n    grupos\r\n      .append(\"text\")\r\n      .text(function(d) {\r\n        return d.nombrecorto;\r\n      })\r\n      .style(\"font-family\", \"'Roboto', sans-serif\")\r\n      .style(\"text-transform\", \"uppercase\")\r\n      .attr(\"x\", function(d) {\r\n        return escalaX(d.puntos[0].fecha) + 25;\r\n      })\r\n      .attr(\"y\", function(d) {\r\n        return escalaY(d.puntos[0].valor) + 5;\r\n      });\r\n\r\n    grupos.selectAll(\"g\").each(function(d) {\r\n      var vs = _.filter(valores, function(v) {\r\n        return v.candidato.id === d.id;\r\n      });\r\n      d3.select(this)\r\n        .selectAll(\"circle\")\r\n        .data(vs)\r\n        .enter()\r\n        .append(\"circle\")\r\n        .attr(\"class\", \"remover\")\r\n        .attr(\"fill\", d.color)\r\n        .attr(\"cx\", function(d) {\r\n          d.x = escalaX(d.fecha);\r\n          return d.x;\r\n        })\r\n        .attr(\"cy\", function(d) {\r\n          return d.y || 625;\r\n        })\r\n        .attr(\"r\", 4)\r\n        .on(\"mouseenter\", function(d) {\r\n          d3.select(this)\r\n            .transition()\r\n            .duration(400)\r\n            .attr(\"r\", 12);\r\n        })\r\n        .on(\"mouseleave\", function(d) {\r\n          d3.select(this)\r\n            .transition()\r\n            .duration(400)\r\n            .attr(\"r\", 4);\r\n        });\r\n    });\r\n\r\n    _.each(arreglo, function(candidato) {\r\n      candidato.tramos = [];\r\n      var n = candidato.puntos.length;\r\n      var i = 0;\r\n      var acumulado = 0;\r\n      for (i = 1; i < n; i++) {\r\n        var xIni = escalaX(candidato.puntos[i - 1].fecha);\r\n        var yIni = escalaY(candidato.puntos[i - 1].valor);\r\n        var xFin = escalaX(candidato.puntos[i].fecha);\r\n        var yFin = escalaY(candidato.puntos[i].valor);\r\n        candidato.tramos.push({\r\n          inicio: [xIni, yIni],\r\n          final: [xFin, yFin],\r\n          acumulado: acumulado\r\n        });\r\n        acumulado += Math.sqrt(\r\n          Math.pow(xFin - xIni, 2) + Math.pow(yFin - yIni, 2)\r\n        );\r\n      }\r\n    });\r\n  }\r\n\r\n  function generaTooltips() {\r\n    var opciones = {\r\n      trigger: \"custom\",\r\n      triggerOpen: {\r\n        mouseenter: true,\r\n        touchstart: true\r\n      },\r\n      triggerClose: {\r\n        mouseleave: true,\r\n        tap: true\r\n      },\r\n      contentAsHTML: true\r\n    };\r\n\r\n    gLineas.selectAll(\"circle\").each(function(d) {\r\n      var contenido = \"<p>\" + getCadenaFecha(d) + \"</p>\";\r\n      contenido += \"<ul>\";\r\n      _.each(d.candidatos, function(candidato) {\r\n        contenido +=\r\n          \"<li style='color:\" +\r\n          candidato.color +\r\n          \"'><span class='valor'>\" +\r\n          _.padStart(_.round(candidato.valor), 2, \"0\") +\r\n          \"</span> \" +\r\n          candidato.nombre +\r\n          \"</li>\";\r\n      });\r\n      contenido += \"</ul>\";\r\n      opciones.content = $(contenido);\r\n      opciones.theme = \"tooltipster-shadow\";\r\n      $(this).tooltipster(opciones);\r\n    });\r\n  }\r\n\r\n  function actualizaTooltips() {\r\n    var seleccionados = _.filter(candidatos, { seleccionado: true });\r\n    var ids = _.map(seleccionados, \"id\");\r\n    gLineas.selectAll(\"circle\").each(function(d) {\r\n      var contenido = \"<p>\" + getCadenaFecha(d) + \"</p>\";\r\n      if (ids.length > 0) {\r\n        contenido += \"<ul>\";\r\n        var candidatos = _.filter(d.candidatos, function(d) {\r\n          return ids.indexOf(d.id) >= 0;\r\n        });\r\n        _.each(candidatos, function(candidato) {\r\n          contenido +=\r\n            \"<li style='color:\" +\r\n            candidato.color +\r\n            \"'><span class='valor'>\" +\r\n            _.padStart(_.round(candidato.valor), 2, \"0\") +\r\n            \"</span> \" +\r\n            candidato.nombre +\r\n            \"</li>\";\r\n        });\r\n        contenido += \"</ul>\";\r\n      }\r\n\r\n      $(this).tooltipster(\"content\", contenido);\r\n    });\r\n  }\r\n\r\n  function getCadenaFecha(obj, mes) {\r\n    if (flagEsp) {\r\n      var meses = {\r\n        1: \"Ene\",\r\n        2: \"Feb\",\r\n        3: \"Mar\",\r\n        4: \"Abr\",\r\n        5: \"May\",\r\n        6: \"Jun\",\r\n        7: \"Jul\",\r\n        8: \"Ago\",\r\n        9: \"Sep\",\r\n        10: \"Oct\",\r\n        11: \"Nov\",\r\n        12: \"Dic\"\r\n      };\r\n    } else {\r\n      var meses = {\r\n        1: \"Jan\",\r\n        2: \"Feb\",\r\n        3: \"Mar\",\r\n        4: \"Apr\",\r\n        5: \"May\",\r\n        6: \"Jun\",\r\n        7: \"Jul\",\r\n        8: \"Aug\",\r\n        9: \"Sep\",\r\n        10: \"Oct\",\r\n        11: \"Nov\",\r\n        12: \"Dec\"\r\n      };\r\n    }\r\n    var cadena = null;\r\n    var arreglo = obj.fechatextual.split(\"-\");\r\n    var anio = parseInt(arreglo[0]);\r\n    var mes = parseInt(arreglo[1]);\r\n    if (arreglo.length === 3) {\r\n      var dia = parseInt(arreglo[2]);\r\n      cadena = dia + \" \" + meses[mes] + \" \" + anio;\r\n    }\r\n    if (arreglo.length === 2) {\r\n      cadena = meses[mes] + \" \" + anio;\r\n    }\r\n    return cadena;\r\n  }\r\n\r\n  function main() {\r\n    var q = d3.queue();\r\n    var urlValoresJSON = contenedor.attr(\"data-valores\") || false;\r\n    var urlValoresCSV = contenedor.attr(\"data-valores-csv\") || false;\r\n    var urlCandidatos = contenedor.attr(\"data-candidatos\") || false;\r\n    if (\r\n      urlCandidatos !== false &&\r\n      (urlValoresJSON !== false || urlValoresCSV !== false)\r\n    ) {\r\n      var flagDatos = \"json\";\r\n      q.defer(d3.json, urlCandidatos + \"?\" + getGUID());\r\n      if (urlValoresJSON !== false) {\r\n        q.defer(d3.json, urlValoresJSON + \"?\" + getGUID());\r\n      } else {\r\n        flagDatos = \"csv\";\r\n        q.defer(d3.csv, urlValoresCSV + \"?\" + getGUID());\r\n      }\r\n      q.awaitAll(function(error, arreglo) {\r\n        candidatos = arreglo[0];\r\n        candidatos.sort(function(a, b) {\r\n          if (a.nombrecorto < b.nombrecorto) {\r\n            return -1;\r\n          }\r\n          if (a.nombrecorto > b.nombrecorto) {\r\n            return 1;\r\n          }\r\n          return 0;\r\n        });\r\n        if (flagDatos === \"json\") {\r\n          var temas = arreglo[1].result.aggregated.topics;\r\n          var resultados = arreglo[1].result.aggregated.result;\r\n          _.each(candidatos, function(candidato) {\r\n            candidato.seleccionado = true;\r\n            candidato.puntos = [];\r\n            var i = _.findIndex(temas, { id: candidato.gid });\r\n            if (i >= 0) {\r\n              candidato.puntos = _.map(resultados, function(r) {\r\n                return {\r\n                  fecha: r.time,\r\n                  fechatextual: r.time,\r\n                  valor: +r.value[i],\r\n                  celda: r.value[i]\r\n                };\r\n              });\r\n            }\r\n          });\r\n        } else {\r\n          var resultados = arreglo[1];\r\n          _.each(candidatos, function(candidato) {\r\n            candidato.seleccionado = true;\r\n            candidato.puntos = [];\r\n            _.each(resultados, function(r) {\r\n              candidato.puntos.push({\r\n                fecha: r.fecha,\r\n                fechatextual: r.fecha,\r\n                valor: +r[candidato.id] || 0,\r\n                celda: r[candidato.id]\r\n              });\r\n            });\r\n          });\r\n        }\r\n\r\n        var obj = {};\r\n        _.each(candidatos, function(candidato) {\r\n          _.each(candidato.puntos, function(punto) {\r\n            if (!obj.hasOwnProperty(punto.fechatextual)) {\r\n              obj[punto.fechatextual] = {\r\n                fecha: punto.fechatextual,\r\n                candidatos: []\r\n              };\r\n            }\r\n            obj[punto.fechatextual].candidatos.push({\r\n              nombre: candidato.nombre,\r\n              nombrecorto: candidato.nombrecorto,\r\n              color: candidato.color,\r\n              valor: punto.celda,\r\n              id: candidato.id\r\n            });\r\n          });\r\n        });\r\n\r\n        var arreglo = _.values(obj);\r\n        valores = [];\r\n        _.each(arreglo, function(obj) {\r\n          var fecha = null;\r\n          var fechatextual = obj.fecha;\r\n          var arrf = obj.fecha.split(\"-\");\r\n          var anio = parseInt(arrf[0]);\r\n          var mes = parseInt(arrf[1]) - 1;\r\n          if (arrf.length === 3) {\r\n            var dia = parseInt(arrf[2]);\r\n            fecha = new Date(anio, mes, dia);\r\n          } else {\r\n            fecha = new Date(anio, mes);\r\n          }\r\n          var cands = obj.candidatos;\r\n          _.each(obj.candidatos, function(candidato) {\r\n            var y = escalaY(+candidato.valor || 0);\r\n            valores.push({\r\n              fecha: fecha,\r\n              fechatextual: fechatextual,\r\n              y: y,\r\n              candidatos: cands,\r\n              candidato: _.find(candidatos, { id: candidato.id })\r\n            });\r\n          });\r\n        });\r\n        var f = d3.queue();\r\n        _.each(candidatos, function(candidato) {\r\n          f.defer(convertImgToBase64URL, candidato);\r\n        });\r\n        f.awaitAll(function(error, a) {\r\n          generaEjes();\r\n          generaLeyenda();\r\n          generaLineas();\r\n          generaSliderTemporal();\r\n          ajustaMarcador(0);\r\n          generaTooltips();\r\n          contenedor.classed(\"espera\", false);\r\n          if (flagIniciar === true) {\r\n            iniciar();\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  function iniciar() {\r\n    marcador\r\n      .transition()\r\n      .duration(4000)\r\n      .attrTween(\"x\", function(d) {\r\n        var i = d3.interpolateNumber(\r\n          _.floor(inicioMedida),\r\n          _.ceil(anchoMedida - anchoMarcador + inicioMedida)\r\n        );\r\n        return function(t) {\r\n          ajustaMarcador(i(t));\r\n          return i(t);\r\n        };\r\n      });\r\n  }\r\n\r\n  function generaSliderTemporal() {\r\n    var drag = d3.behavior\r\n      .drag()\r\n      .on(\"dragstart\", dragstarted)\r\n      .on(\"drag\", dragged)\r\n      .on(\"dragend\", dragended);\r\n\r\n    var fondo = gSlider\r\n      .append(\"rect\")\r\n      .attr(\"fill\", \"white\")\r\n      .attr(\"x\", 0)\r\n      .attr(\"y\", 0)\r\n      .attr(\"width\", 760)\r\n      .attr(\"height\", 60)\r\n      .style(\"filter\", \"url(#\" + idSombra + \")\");\r\n\r\n    var medidaCompleta = gSlider\r\n      .append(\"rect\")\r\n      .attr(\"fill\", \"#cdcdcd\")\r\n      .attr(\"x\", inicioMedida)\r\n      .attr(\"y\", 20)\r\n      .attr(\"width\", anchoMedida)\r\n      .attr(\"height\", 20);\r\n\r\n    medida = gSlider.append(\"rect\");\r\n    medida\r\n      .attr(\"fill\", \"grey\")\r\n      .attr(\"x\", inicioMedida)\r\n      .attr(\"y\", 20)\r\n      .attr(\"width\", anchoMarcador / 2)\r\n      .attr(\"height\", 20)\r\n      .attr(\"class\", \"ignorar\");\r\n\r\n    marcador = gSlider.append(\"rect\");\r\n    marcador\r\n      .attr(\"fill\", \"#000000\")\r\n      .attr(\"x\", inicioMedida)\r\n      .attr(\"y\", 10)\r\n      .attr(\"rx\", 10)\r\n      .attr(\"ry\", 10)\r\n      .attr(\"width\", 101)\r\n      .attr(\"height\", 40)\r\n      .attr(\"class\", \"arrastrar marcador\")\r\n      .call(drag);\r\n  }\r\n\r\n  function dragstarted() {\r\n    d3.event.sourceEvent.stopPropagation();\r\n    offsetMarcador = false;\r\n    d3.select(this).attr(\"class\", \"arrastrando marcador\");\r\n  }\r\n\r\n  function dragged() {\r\n    var x = d3.event.x;\r\n    ajustaMarcador(x);\r\n  }\r\n\r\n  function dragended() {\r\n    offsetMarcador = false;\r\n    d3.select(this).attr(\"class\", \"arrastrar marcador\");\r\n  }\r\n\r\n  function ajustaMarcador(x) {\r\n    if (offsetMarcador === false) {\r\n      offsetMarcador = x - +marcador.attr(\"x\");\r\n    }\r\n    var nx = x - offsetMarcador;\r\n    nx = nx <= inicioMedida ? inicioMedida : nx;\r\n    nx =\r\n      nx >= anchoMedida + inicioMedida - anchoMarcador\r\n        ? anchoMedida + inicioMedida - anchoMarcador\r\n        : nx;\r\n    posicion = nx - inicioMedida;\r\n\r\n    var xLineas = conversionEscalaX(posicion);\r\n\r\n    medida.attr(\"width\", nx - inicioMedida + anchoMarcador / 2);\r\n    marcador.attr(\"x\", nx);\r\n\r\n    gLineas\r\n      .selectAll(\"image\")\r\n      .each(function(d) {\r\n        d.punto = {};\r\n        d.tramo =\r\n          _.find(d.tramos, function(tramo) {\r\n            return tramo.inicio[0] <= xLineas && xLineas <= tramo.final[0];\r\n          }) || false;\r\n        tramoEscalaY\r\n          .domain([d.tramo.inicio[0], d.tramo.final[0]])\r\n          .range([d.tramo.inicio[1], d.tramo.final[1]]);\r\n        d.punto.x = xLineas;\r\n        d.punto.y = tramoEscalaY(xLineas);\r\n\r\n        var punto =\r\n          _.find(d.rpuntos, function(p) {\r\n            return p.x <= xLineas;\r\n          }) || false;\r\n        var texto = getCadenaFecha(punto, \"short\");\r\n        periodoTexto.text(texto);\r\n      })\r\n      .attr(\"x\", function(d) {\r\n        return d.punto.x;\r\n      })\r\n      .attr(\"y\", function(d) {\r\n        return d.punto.y;\r\n      });\r\n\r\n    gLineas\r\n      .selectAll(\"text\")\r\n      .attr(\"x\", xLineas + 25)\r\n      .attr(\"y\", function(d) {\r\n        return d.punto.y;\r\n      });\r\n\r\n    gLineas\r\n      .selectAll(\"circle\")\r\n      .attr(\"opacity\", function(d) {\r\n        return d.x > xLineas ? 0 : 1;\r\n      })\r\n      .style(\"display\", function(d) {\r\n        return d.x > xLineas ? \"none\" : \"\";\r\n      });\r\n\r\n    gLineas.selectAll(\"path\").call(transicionLinea);\r\n  }\r\n\r\n  function transicionLinea(path) {\r\n    path\r\n      .transition()\r\n      .duration(0)\r\n      .attrTween(\"stroke-dasharray\", function(d) {\r\n        var path = d3.select(this);\r\n        d.linea.parcial =\r\n          d.tramo.acumulado +\r\n          Math.sqrt(\r\n            Math.pow(d.punto.x - d.tramo.inicio[0], 2) +\r\n              Math.pow(d.punto.y - d.tramo.inicio[1], 2)\r\n          );\r\n        var path = d3.select(this);\r\n        var l = d.linea.parcial;\r\n        if (d.linea.parcial > d.linea.largo) {\r\n          d.linea.parcial = d.linea.largo;\r\n        }\r\n        if (l === 0) {\r\n          var i = d3.interpolateString(\"0,\" + 0, 0 + \",\" + 1);\r\n        } else {\r\n          var i = d3.interpolateString(\"0,\" + l, l + \",\" + 1000 * l);\r\n        }\r\n        return function(t) {\r\n          var p = path.node().getPointAtLength(t * l);\r\n          return i(t);\r\n        };\r\n      });\r\n  }\r\n\r\n  function getGUID() {\r\n    return (\r\n      Date.now().toString(36) +\r\n      Math.random()\r\n        .toString(36)\r\n        .substr(2, 5)\r\n    ).toUpperCase();\r\n  }\r\n\r\n  function endall(transition, callback) {\r\n    var n = 0;\r\n    transition\r\n      .each(function() {\r\n        ++n;\r\n      })\r\n      .each(\"end\", function() {\r\n        if (!--n) callback.apply(this, arguments);\r\n      });\r\n  }\r\n\r\n  function candidatosAGris() {\r\n    gLeyenda\r\n      .selectAll(\"image\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"filter\", function(d, i) {\r\n        return d.seleccionado === true ? \"\" : \"url(#\" + idGris + \")\";\r\n      });\r\n\r\n    gLineas\r\n      .selectAll(\"image\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"filter\", function(d, i) {\r\n        return d.seleccionado === true ? \"\" : \"url(#\" + idGris + \")\";\r\n      });\r\n  }\r\n\r\n  function descargaVisualizacion(elemento) {\r\n    var el = $(elemento).closest(\"div.visualizacion\");\r\n    var padre = d3\r\n      .select(el[0])\r\n      .node()\r\n      .cloneNode(true);\r\n    padre = d3.select(padre);\r\n    var svg = padre.select(\"svg\");\r\n    var nombreSVG = \"trendlecciones.svg\";\r\n    var nombrePNG = \"trendlecciones-linea-de-tiempo.png\";\r\n    svg.attr(\"height\", medidas.alto + margin.top + margin.bottom);\r\n    svg.attr(\"width\", medidas.ancho + margin.left + margin.right);\r\n    var html = svg\r\n      .attr(\"title\", \"Trendlecciones\")\r\n      .attr(\"version\", 1.1)\r\n      .attr(\"xmlns\", \"http://www.w3.org/2000/svg\")\r\n      .attr(\"xmlns:xlink\", \"http://www.w3.org/1999/xlink\")\r\n      .node().parentNode.innerHTML;\r\n    html = unescape(encodeURIComponent(html));\r\n    var contenidoSVG = btoa(html);\r\n    var imageArtefacto = new Image();\r\n    imageArtefacto.width = medidas.ancho + margin.left + margin.right;\r\n    imageArtefacto.height = medidas.alto + margin.top + margin.bottom;\r\n    imageArtefacto.onload = function() {\r\n      var canvasArtefacto = document.createElement(\"canvas\");\r\n      canvasArtefacto.width = imageArtefacto.width;\r\n      canvasArtefacto.height = imageArtefacto.height;\r\n      canvasArtefacto.getContext(\"2d\").drawImage(imageArtefacto, 0, 0);\r\n      var contenidoPNG = canvasArtefacto.toDataURL(\"image/png\");\r\n      download(contenidoPNG, nombrePNG, \"image/png\");\r\n    };\r\n    imageArtefacto.src = \"data:image/svg+xml;base64,\" + contenidoSVG;\r\n  }\r\n\r\n  function convertImgToBase64URL(d, callback) {\r\n    var img = new Image();\r\n    //img.crossOrigin = \"Anonymous\";\r\n    img.onload = function() {\r\n      var canvas = document.createElement(\"CANVAS\"),\r\n        ctx = canvas.getContext(\"2d\"),\r\n        dataURL;\r\n      canvas.height = img.height;\r\n      canvas.width = img.width;\r\n      ctx.drawImage(img, 0, 0);\r\n      dataURL = canvas.toDataURL(\"image/png\");\r\n      d.imgb64 = dataURL;\r\n      canvas = null;\r\n      callback(null, d);\r\n    };\r\n    d.img = \"img/candidatos/\" + d.img;\r\n    img.src = d.img;\r\n  }\r\n\r\n  setup(el);\r\n\r\n  return { iniciar: iniciar };\r\n};\r\n","var MapaABarras = function($, el, flagIniciar) {\r\n  flagIniciar = flagIniciar || false;\r\n  var flagEsp =\r\n    window.location.pathname.split(\"/\").indexOf(\"eng\") >= 0 ? false : true;\r\n\r\n  var candidatos = null;\r\n  var periodos = null;\r\n  var preferencias = null;\r\n  var candidatoEnBlanco = { id: \"\", nombre: \"\", color: \"#000000\", altura: 0 };\r\n\r\n  var projection = d3.geo\r\n    .mercator()\r\n    .scale(1100)\r\n    .center([-108.34034978813841, 24.012062015793]);\r\n  var path = d3.geo.path().projection(projection);\r\n\r\n  var paddingEstados = 8;\r\n\r\n  var fMexico = false;\r\n\r\n  var margin = { top: 20, right: 20, bottom: 20, left: 20 };\r\n  var medidas = {\r\n    ancho: 800 - margin.left - margin.right,\r\n    alto: 800 - margin.top - margin.bottom\r\n  };\r\n\r\n  var tarjeta = { ancho: 133, alto: 124 };\r\n  var retrato = { ancho: 85, alto: 85 };\r\n  var columna = { ancho: 51, alto: 51 };\r\n\r\n  var h = 541;\r\n\r\n  var estiloLeyenda = {\r\n    \"font-family\": \"'Roboto', sans-serif\",\r\n    \"font-size\": \"18px\",\r\n    \"font-style\": \"normal\",\r\n    \"text-anchor\": \"middle\",\r\n    \"alignment-baseline\": \"central\",\r\n    \"text-transform\": \"uppercase\",\r\n    \"font-kerning\": \"normal\"\r\n  };\r\n\r\n  var estiloColumna = {\r\n    \"font-family\": \"'Roboto', sans-serif\",\r\n    \"font-size\": \"14px\",\r\n    \"font-style\": \"normal\",\r\n    \"text-anchor\": \"middle\",\r\n    \"alignment-baseline\": \"central\",\r\n    \"text-transform\": \"uppercase\",\r\n    \"font-kerning\": \"normal\"\r\n  };\r\n\r\n  var estiloColumnaEstados = {\r\n    \"font-family\": \"'Roboto', sans-serif\",\r\n    \"font-size\": \"10px\",\r\n    \"font-style\": \"normal\",\r\n    \"text-anchor\": \"middle\",\r\n    \"alignment-baseline\": \"central\",\r\n    \"text-transform\": \"uppercase\",\r\n    stroke: \"#000000\",\r\n    fill: \"#000000\",\r\n    \"font-weight\": 100,\r\n    \"font-kerning\": \"normal\"\r\n  };\r\n\r\n  var estiloPeriodo = {\r\n    \"font-family\": \"'Roboto', sans-serif\",\r\n    \"font-size\": \"18px\",\r\n    \"font-style\": \"normal\",\r\n    \"text-anchor\": \"middle\",\r\n    \"alignment-baseline\": \"central\",\r\n    \"text-transform\": \"uppercase\",\r\n    \"font-kerning\": \"normal\"\r\n  };\r\n\r\n  var contenedor = null;\r\n  var svg = null;\r\n  var gCandidatos = null;\r\n  var mexico = null;\r\n  var gLeyenda = null;\r\n  var gSlider = null;\r\n\r\n  var periodoTexto = null;\r\n\r\n  var idSombra = getGUID();\r\n  var idGris = getGUID();\r\n\r\n  var anchoMarcador = 101;\r\n  var inicioMedida = 22.5;\r\n  var anchoMedida = 707;\r\n  var medida = null;\r\n\r\n  var offsetMarcador = false;\r\n  var index = 0;\r\n\r\n  function setup(el) {\r\n    var elemento = null;\r\n    var flag = null;\r\n    contenedor = d3.select(el);\r\n    elemento = contenedor.node() || false;\r\n\r\n    if (elemento !== false) {\r\n      flag = contenedor.attr(\"data-visualizacion\") || false;\r\n      if (flag === false) {\r\n        contenedor.attr(\"data-visualizacion\", \"true\");\r\n        contenedor.classed(\"espera\", true);\r\n        contenedor.selectAll(\"svg\").remove();\r\n\r\n        svg = contenedor\r\n          .append(\"svg\")\r\n          .attr(\"preserveAspectRatio\", \"xMidYMid\")\r\n          .attr(\r\n            \"viewBox\",\r\n            \"0 0 \" +\r\n              (medidas.ancho + margin.left + margin.right) +\r\n              \" \" +\r\n              (medidas.alto + margin.top + margin.bottom)\r\n          );\r\n\r\n        var defs = svg.append(\"defs\");\r\n        var filter = defs\r\n          .append(\"filter\")\r\n          .attr(\"id\", idSombra)\r\n          .attr(\"height\", \"130%\");\r\n\r\n        filter\r\n          .append(\"feGaussianBlur\")\r\n          .attr(\"in\", \"SourceAlpha\")\r\n          .attr(\"stdDeviation\", \"2\");\r\n\r\n        filter\r\n          .append(\"feOffset\")\r\n          .attr(\"dx\", \"2\")\r\n          .attr(\"dy\", \"2\")\r\n          .attr(\"result\", \"offsetblur\");\r\n\r\n        filter\r\n          .append(\"feFlood\")\r\n          .attr(\"flood-color\", \"rgb(0,0,0)\")\r\n          .attr(\"flood-opacity\", \"0.2\");\r\n\r\n        filter\r\n          .append(\"feComposite\")\r\n          .attr(\"in2\", \"offsetblur\")\r\n          .attr(\"operator\", \"in\");\r\n\r\n        var feMerge = filter.append(\"feMerge\");\r\n        feMerge.append(\"feMergeNode\");\r\n        feMerge.append(\"feMergeNode\").attr(\"in\", \"SourceGraphic\");\r\n\r\n        defs\r\n          .append(\"filter\")\r\n          .attr(\"id\", idGris)\r\n          .append(\"feColorMatrix\")\r\n          .attr(\"type\", \"matrix\")\r\n          .attr(\r\n            \"values\",\r\n            \"0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\"\r\n          );\r\n\r\n        svg\r\n          .append(\"rect\")\r\n          .attr(\"fill\", \"#ffffff\")\r\n          .attr(\"x\", 0)\r\n          .attr(\"y\", 0)\r\n          .attr(\"width\", medidas.ancho + margin.left + margin.right)\r\n          .attr(\"height\", medidas.alto + margin.top + margin.bottom);\r\n\r\n        svg = svg\r\n          .append(\"g\")\r\n          .attr(\r\n            \"transform\",\r\n            \"translate(\" + margin.left + \",\" + margin.top + \")\"\r\n          );\r\n\r\n        svg\r\n          .append(\"rect\")\r\n          .attr(\"width\", medidas.ancho)\r\n          .attr(\"height\", medidas.alto)\r\n          .attr(\"fill\", \"transparent\");\r\n\r\n        svg\r\n          .append(\"rect\")\r\n          .attr(\"class\", \"cursor\")\r\n          .attr(\"x\", 3)\r\n          .attr(\"y\", 0)\r\n          .attr(\"width\", 602)\r\n          .attr(\"height\", h)\r\n          .attr(\"fill\", \"transparent\")\r\n          .on(\"click\", toggleMexico);\r\n\r\n        gCandidatos = svg.append(\"g\");\r\n        mexico = svg.append(\"g\");\r\n\r\n        periodoTexto = svg\r\n          .append(\"g\")\r\n          .attr(\"transform\", \"translate(0,682)\")\r\n          .append(\"text\")\r\n          .attr(\"x\", medidas.ancho / 2)\r\n          .style(estiloPeriodo);\r\n\r\n        gLeyenda = svg.append(\"g\");\r\n        gSlider = svg\r\n          .append(\"g\")\r\n          .attr(\"transform\", \"translate(0,\" + (medidas.alto - 60) + \")\");\r\n\r\n        var descarga = $(elemento)\r\n          .closest(\"div.visualizacion\")\r\n          .next()\r\n          .next()\r\n          .find(\"img[alt=download]\")\r\n          .closest(\"a\");\r\n        if (descarga.length === 0) {\r\n          descarga = $(elemento)\r\n            .closest(\"div.visualizacion\")\r\n            .closest(\"section\")\r\n            .find(\"img[alt=download]\")\r\n            .closest(\"a\");\r\n        }\r\n        if (descarga.length !== 0) {\r\n          descarga.attr(\"href\", \"#\").click(function(event) {\r\n            event.preventDefault();\r\n            event.stopPropagation();\r\n            descargaVisualizacion(elemento);\r\n          });\r\n        }\r\n\r\n        main();\r\n      }\r\n    }\r\n  }\r\n\r\n  function main() {\r\n    var q = d3.queue();\r\n    var urlValoresJSON = contenedor.attr(\"data-valores-json\") || false;\r\n    var urlCandidatos = contenedor.attr(\"data-candidatos\") || false;\r\n    if (urlCandidatos !== false && urlValoresJSON !== false) {\r\n      q.defer(d3.json, \"json/mexico.json\");\r\n      q.defer(d3.json, urlCandidatos + \"?\" + getGUID());\r\n      q.defer(d3.json, urlValoresJSON + \"?\" + getGUID());\r\n      q.awaitAll(function(error, arreglo) {\r\n        var datosMexico = arreglo[0];\r\n        candidatos = arreglo[1];\r\n        periodos = arreglo[2];\r\n        var f = d3.queue();\r\n        _.each(candidatos, function(candidato) {\r\n          f.defer(convertImgToBase64URL, candidato);\r\n        });\r\n        f.awaitAll(function(error, a) {\r\n          candidatos.sort(function(a, b) {\r\n            if (a.nombrecorto < b.nombrecorto) {\r\n              return -1;\r\n            }\r\n            if (a.nombrecorto > b.nombrecorto) {\r\n              return 1;\r\n            }\r\n            return 0;\r\n          });\r\n          _.each(candidatos, function(d) {\r\n            d.seleccionado = true;\r\n          });\r\n          var clave = getCandidatosSeleccionados();\r\n          _.each(periodos, function(p, i) {\r\n            p.seleccionado = i === 0 ? true : false;\r\n          });\r\n          preferencias = getConjuntoDeDatos(clave);\r\n          generaLeyenda();\r\n          generaCandidatos();\r\n          generaMexico(datosMexico);\r\n          generaSliderTemporal();\r\n          generaTooltips();\r\n          actualizaMexico();\r\n          contenedor.classed(\"espera\", false);\r\n          if (flagIniciar === true) {\r\n            iniciar();\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  function iniciar() {\r\n    explotaMexico();\r\n    periodoTexto.text(flagEsp ? periodos[0].nombre : periodos[0].nombrei);\r\n  }\r\n\r\n  function cambiaPeriodo(numero) {\r\n    numero = numero >= periodos.length ? 0 : numero;\r\n    _.each(periodos, function(p, i) {\r\n      p.seleccionado = i === numero ? true : false;\r\n    });\r\n    var clave = getCandidatosSeleccionados();\r\n    preferencias = getConjuntoDeDatos(clave);\r\n    actualizaMexico(true);\r\n  }\r\n\r\n  function getGUID() {\r\n    return (\r\n      Date.now().toString(36) +\r\n      Math.random()\r\n        .toString(36)\r\n        .substr(2, 5)\r\n    ).toUpperCase();\r\n  }\r\n\r\n  function getCandidatosSeleccionados() {\r\n    var arreglo = _.filter(candidatos, { seleccionado: true });\r\n    arreglo = _.map(arreglo, \"id\");\r\n    arreglo.sort();\r\n    return arreglo.join(\"-\");\r\n  }\r\n\r\n  function getConjuntoDeDatos(cadena) {\r\n    var arreglo = [];\r\n    var periodo = _.find(periodos, { seleccionado: true }) || false;\r\n    if (periodo !== false) {\r\n      var obj = periodo.combinaciones[cadena] || {};\r\n      _.each(obj, function(v, c) {\r\n        var max = _.maxBy(_.keys(v), function(o) {\r\n          return v[o];\r\n        });\r\n        arreglo.push({ estado: +c, valor: max });\r\n      });\r\n    }\r\n    return arreglo;\r\n  }\r\n\r\n  function generaLeyenda() {\r\n    gLeyenda.attr(\r\n      \"transform\",\r\n      \"translate(\" + (medidas.ancho - tarjeta.ancho) + \",0)\"\r\n    );\r\n\r\n    var grupos = gLeyenda\r\n      .selectAll(\"g\")\r\n      .data(candidatos)\r\n      .enter()\r\n      .append(\"g\")\r\n      .attr(\"fill\", function(d) {\r\n        return d.color;\r\n      })\r\n      .attr(\"transform\", function(d, i) {\r\n        return \"translate(0,\" + i * (tarjeta.alto + 25) + \")\";\r\n      });\r\n\r\n    grupos\r\n      .append(\"rect\")\r\n      .attr(\"x\", 0)\r\n      .attr(\"y\", 0)\r\n      .attr(\"class\", \"cursor\")\r\n      .attr(\"width\", tarjeta.ancho)\r\n      .attr(\"height\", tarjeta.alto)\r\n      .attr(\"fill\", \"#ffffff\")\r\n      .style(\"filter\", \"url(#\" + idSombra + \")\")\r\n      .on(\"click\", toggleCandidato);\r\n\r\n    grupos\r\n      .append(\"svg:image\")\r\n      .attr(\"class\", \"cursor\")\r\n      .attr(\"x\", (tarjeta.ancho - retrato.ancho) / 2)\r\n      .attr(\"y\", 10)\r\n      .attr(\"width\", retrato.ancho)\r\n      .attr(\"height\", retrato.alto)\r\n      .attr(\"xlink:href\", function(d) {\r\n        return d.imgb64;\r\n      })\r\n      .attr(\"fill\", \"transparent\")\r\n      .on(\"click\", toggleCandidato);\r\n\r\n    grupos\r\n      .append(\"text\")\r\n      .text(function(d) {\r\n        return d.nombrecorto;\r\n      })\r\n      .style(\"stroke\", function(d) {\r\n        return d.color;\r\n      })\r\n      .style(\"fill\", function(d) {\r\n        return d.color;\r\n      })\r\n      .style(estiloLeyenda)\r\n      .attr(\"x\", tarjeta.ancho / 2)\r\n      .attr(\"y\", retrato.alto + 30);\r\n  }\r\n\r\n  function toggleCandidato(d) {\r\n    var flag = false;\r\n    if (d.seleccionado === false) {\r\n      flag = true;\r\n    } else {\r\n      var arreglo = _.filter(candidatos, { seleccionado: true });\r\n      if (arreglo.length >= 3) {\r\n        flag = true;\r\n      }\r\n    }\r\n    if (flag === true) {\r\n      d.seleccionado = !d.seleccionado;\r\n      var clave = getCandidatosSeleccionados();\r\n      preferencias = getConjuntoDeDatos(clave);\r\n      actualizaMexico(true);\r\n    }\r\n  }\r\n\r\n  function generaCandidatos() {\r\n    gCandidatos.attr(\"transform\", \"translate(50,0)\");\r\n\r\n    var grupos = gCandidatos\r\n      .selectAll(\"g\")\r\n      .data(candidatos)\r\n      .enter()\r\n      .append(\"g\")\r\n      .attr(\"fill\", function(d) {\r\n        return d.color;\r\n      });\r\n\r\n    grupos\r\n      .append(\"svg:image\")\r\n      .attr(\"x\", function(d, i) {\r\n        d.x = 152 * i;\r\n        return d.x;\r\n      })\r\n      .attr(\"y\", 590)\r\n      .attr(\"y\", h + 19)\r\n      .attr(\"width\", columna.ancho)\r\n      .attr(\"height\", columna.alto)\r\n      .attr(\"xlink:href\", function(d) {\r\n        return d.imgb64;\r\n      })\r\n      .attr(\"fill\", \"transparent\")\r\n      .attr(\"opacity\", 0);\r\n\r\n    grupos\r\n      .append(\"text\")\r\n      .text(function(d) {\r\n        return d.nombrecorto;\r\n      })\r\n      .style(\"stroke\", function(d) {\r\n        return d.color;\r\n      })\r\n      .style(\"fill\", function(d) {\r\n        return d.color;\r\n      })\r\n      .style(estiloColumna)\r\n      .attr(\"x\", function(d) {\r\n        return d.x + columna.ancho / 2;\r\n      })\r\n      .attr(\"y\", 665)\r\n      .attr(\"y\", h + 94)\r\n      .attr(\"opacity\", 0);\r\n\r\n    grupos\r\n      .append(\"text\")\r\n      .attr(\"class\", \"cuenta\")\r\n      .text(flagEsp ? \"0 estados\" : \"0 states\")\r\n      .style(estiloColumnaEstados)\r\n      .attr(\"x\", function(d) {\r\n        return d.x + columna.ancho / 2;\r\n      })\r\n      .attr(\"y\", 680)\r\n      .attr(\"y\", h + 109)\r\n      .attr(\"opacity\", 0);\r\n\r\n    grupos\r\n      .append(\"rect\")\r\n      .attr(\"class\", \"ignorar\")\r\n      .attr(\"width\", 146)\r\n      .attr(\"height\", 0)\r\n      .attr(\"x\", function(d, i) {\r\n        return d.x - 47;\r\n      })\r\n      .attr(\"y\", h)\r\n      .attr(\"fill\", function(d) {\r\n        return d.color;\r\n      })\r\n      .style(\"opacity\", 0.2);\r\n  }\r\n\r\n  function actualizaMexico(accion) {\r\n    accion = accion || false;\r\n    _.each(candidatos, function(c) {\r\n      c.altura = 0;\r\n    });\r\n    var alturaBarra = h;\r\n    var objPreferencias = _.countBy(preferencias, \"valor\");\r\n    var max = _.max(_.values(objPreferencias));\r\n    var objCuentas = {};\r\n    _.each(objPreferencias, function(v, c) {\r\n      objCuentas[c] = 0;\r\n    });\r\n\r\n    var alturaP = alturaBarra / max;\r\n    var altura = alturaP - paddingEstados;\r\n\r\n    _.each(candidatos, function(candidato) {\r\n      candidato.altura = alturaP * (objPreferencias[candidato.id] || 0);\r\n    });\r\n\r\n    var estados = mexico.selectAll(\"path\");\r\n\r\n    estados.each(function(d) {\r\n      d.properties.preferencia = _.find(preferencias, {\r\n        estado: d.properties.ID_1\r\n      });\r\n      d.properties.candidato =\r\n        _.find(candidatos, { id: d.properties.preferencia.valor }) ||\r\n        candidatoEnBlanco;\r\n    });\r\n\r\n    estados\r\n      .transition()\r\n      .duration(1000)\r\n      .attr(\"transform\", \"translate(-310,90)\")\r\n      .attr(\"fill\", function(d) {\r\n        return d.properties.candidato.color;\r\n      })\r\n      .each(function(d) {\r\n        var centroid = path.centroid(d);\r\n        var x = centroid[0];\r\n        var y = centroid[1];\r\n        objCuentas[d.properties.candidato.id] =\r\n          objCuentas[d.properties.candidato.id] + 1;\r\n        d.x = d.properties.candidato.x + 50 + columna.ancho / 2;\r\n        d.y =\r\n          alturaBarra -\r\n          objCuentas[d.properties.candidato.id] * alturaP +\r\n          alturaP / 2;\r\n\r\n        d.xc = x;\r\n        d.yc = y;\r\n        d.altura = altura;\r\n\r\n        d.caja = this.getBBox();\r\n        var escala = d.altura / d.caja.height;\r\n        d.escala = escala;\r\n\r\n        var contenido =\r\n          \"<p>\" +\r\n          d.properties.NAME_1 +\r\n          \"<br>\" +\r\n          d.properties.candidato.nombre +\r\n          \"</p>\";\r\n        $(this).tooltipster(\"content\", contenido);\r\n      });\r\n\r\n    gLeyenda\r\n      .selectAll(\"g\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"opacity\", function(d) {\r\n        return d.seleccionado === true ? 1 : 0.3;\r\n      })\r\n      .call(endall, candidatosAGris);\r\n\r\n    gLeyenda\r\n      .selectAll(\"text\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"fill\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      })\r\n      .style(\"stroke\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      });\r\n\r\n    gCandidatos\r\n      .selectAll(\"g\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"opacity\", function(d) {\r\n        return d.seleccionado === true ? 1 : 0.3;\r\n      });\r\n\r\n    gLeyenda\r\n      .selectAll(\"text\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"fill\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      })\r\n      .style(\"stroke\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      });\r\n\r\n    gCandidatos\r\n      .selectAll(\"text\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"fill\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      })\r\n      .style(\"stroke\", function(d) {\r\n        return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n      });\r\n\r\n    gCandidatos.selectAll(\"text.cuenta\").text(function(d) {\r\n      var n = objPreferencias[d.id] || 0;\r\n      var mensaje = flagEsp ? \"estados\" : \"states\";\r\n      if (n === 1) {\r\n        mensaje = flagEsp ? \"estado\" : \"state\";\r\n      }\r\n      return n + \" \" + mensaje;\r\n    });\r\n\r\n    if (accion === true && fMexico === true) {\r\n      explotaMexico();\r\n    }\r\n  }\r\n\r\n  function candidatosAGris() {\r\n    gLeyenda\r\n      .selectAll(\"image\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"filter\", function(d, i) {\r\n        return d.seleccionado === true ? \"\" : \"url(#\" + idGris + \")\";\r\n      });\r\n    gCandidatos\r\n      .selectAll(\"image\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"filter\", function(d, i) {\r\n        return d.seleccionado === true ? \"\" : \"url(#\" + idGris + \")\";\r\n      });\r\n  }\r\n\r\n  function generaMexico(d) {\r\n    mexico\r\n      .selectAll(\"path\")\r\n      .data(topojson.feature(d, d.objects.mexico).features)\r\n      .enter()\r\n      .append(\"path\")\r\n      .each(function(d) {\r\n        d.properties.preferencia = _.find(preferencias, {\r\n          estado: d.properties.ID_1\r\n        });\r\n        d.properties.candidato =\r\n          _.find(candidatos, { id: d.properties.preferencia.valor }) ||\r\n          candidatoEnBlanco;\r\n      })\r\n      .attr(\"transform\", \"translate(-310,90)\")\r\n      .attr(\"d\", path)\r\n      .attr(\"class\", \"estado mexico\")\r\n      .attr(\"fill\", function(d) {\r\n        return d.properties.candidato.color;\r\n      })\r\n      .style(\"stroke\", \"#ffffff\")\r\n      .style(\"stroke-width\", function(d) {\r\n        return 1 + \"px\";\r\n      });\r\n  }\r\n\r\n  function generaSliderTemporal() {\r\n    var drag = d3.behavior\r\n      .drag()\r\n      .on(\"dragstart\", dragstarted)\r\n      .on(\"drag\", dragged)\r\n      .on(\"dragend\", dragended);\r\n\r\n    var fondo = gSlider\r\n      .append(\"rect\")\r\n      .attr(\"fill\", \"white\")\r\n      .attr(\"x\", 0)\r\n      .attr(\"y\", 0)\r\n      .attr(\"width\", 760)\r\n      .attr(\"height\", 60)\r\n      .style(\"filter\", \"url(#\" + idSombra + \")\");\r\n\r\n    var medidaCompleta = gSlider\r\n      .append(\"rect\")\r\n      .attr(\"fill\", \"#cdcdcd\")\r\n      .attr(\"x\", inicioMedida)\r\n      .attr(\"y\", 20)\r\n      .attr(\"width\", anchoMedida)\r\n      .attr(\"height\", 20);\r\n\r\n    medida = gSlider\r\n      .append(\"rect\")\r\n      .attr(\"fill\", \"grey\")\r\n      .attr(\"x\", inicioMedida)\r\n      .attr(\"y\", 20)\r\n      .attr(\"width\", anchoMarcador / 2)\r\n      .attr(\"height\", 20)\r\n      .attr(\"class\", \"ignorar\");\r\n\r\n    var marcador = gSlider\r\n      .append(\"rect\")\r\n      .attr(\"fill\", \"#000000\")\r\n      .attr(\"x\", 300 + inicioMedida - anchoMarcador / 2)\r\n      .attr(\"x\", inicioMedida)\r\n      .attr(\"y\", 10)\r\n      .attr(\"rx\", 10)\r\n      .attr(\"ry\", 10)\r\n      .attr(\"width\", 101)\r\n      .attr(\"height\", 40)\r\n      .attr(\"class\", \"arrastrar\")\r\n      .call(drag);\r\n  }\r\n\r\n  function dragstarted() {\r\n    d3.event.sourceEvent.stopPropagation();\r\n    offsetMarcador = false;\r\n    d3.select(this).attr(\"class\", \"arrastrando marcador\");\r\n  }\r\n\r\n  function dragged() {\r\n    var x = d3.event.x;\r\n    var marcador = d3.select(this);\r\n    ajustaMarcador(marcador, x);\r\n  }\r\n\r\n  function dragended() {\r\n    offsetMarcador = false;\r\n    cambiaPeriodo(index);\r\n    d3.select(this).attr(\"class\", \"arrastrar marcador\");\r\n  }\r\n\r\n  function ajustaMarcador(rect, x) {\r\n    var total = anchoMedida - anchoMarcador;\r\n    var anchoSegmento = total / periodos.length;\r\n    if (offsetMarcador === false) {\r\n      offsetMarcador = x - rect.attr(\"x\");\r\n    }\r\n    var nx = x - offsetMarcador;\r\n    nx = nx <= inicioMedida ? inicioMedida : nx;\r\n    nx =\r\n      nx >= anchoMedida + inicioMedida - anchoMarcador\r\n        ? anchoMedida + inicioMedida - anchoMarcador\r\n        : nx;\r\n    medida.attr(\"width\", nx - inicioMedida + anchoMarcador / 2);\r\n    rect.attr(\"x\", nx);\r\n    var pos = nx - inicioMedida;\r\n    index = parseInt(pos / anchoSegmento);\r\n    index = index >= periodos.length ? periodos.length - 1 : index;\r\n\r\n    periodoTexto.text(\r\n      flagEsp ? periodos[index].nombre : periodos[index].nombrei\r\n    );\r\n  }\r\n\r\n  function toggleMexico() {\r\n    if (fMexico === false) {\r\n      explotaMexico();\r\n    } else {\r\n      juntaMexico();\r\n    }\r\n  }\r\n\r\n  function explotaMexico() {\r\n    fMexico = true;\r\n\r\n    gCandidatos\r\n      .selectAll(\"rect\")\r\n      .transition()\r\n      .duration(2000)\r\n      .attr(\"height\", function(d) {\r\n        return d.altura || 0;\r\n      })\r\n      .attr(\"y\", function(d, i) {\r\n        return h - (d.altura || 0);\r\n      })\r\n      .attr(\"fill\", function(d) {\r\n        return d.color;\r\n      });\r\n\r\n    gCandidatos\r\n      .selectAll(\"image\")\r\n      .transition()\r\n      .duration(2000)\r\n      .attr(\"opacity\", 1);\r\n\r\n    gCandidatos\r\n      .selectAll(\"text\")\r\n      .transition()\r\n      .duration(2000)\r\n      .attr(\"opacity\", 1);\r\n\r\n    mexico\r\n      .selectAll(\"path\")\r\n      .transition()\r\n      .duration(2000)\r\n      .attr(\"fill\", function(d) {\r\n        return d.properties.candidato.color;\r\n      })\r\n      .style(\"stroke-width\", function(d) {\r\n        return 0 + \"px\";\r\n      })\r\n      .attr(\"transform\", function(d, i) {\r\n        return (\r\n          \"translate(\" +\r\n          (d.x - d.xc) +\r\n          \",\" +\r\n          (d.y - d.yc) +\r\n          \") translate(\" +\r\n          d.xc +\r\n          \",\" +\r\n          d.yc +\r\n          \") scale(\" +\r\n          d.escala +\r\n          \") translate(\" +\r\n          -d.xc +\r\n          \",\" +\r\n          -d.yc +\r\n          \")\"\r\n        );\r\n      });\r\n  }\r\n\r\n  function juntaMexico() {\r\n    fMexico = false;\r\n    gCandidatos\r\n      .selectAll(\"rect\")\r\n      .transition()\r\n      .duration(2000)\r\n      .attr(\"height\", 0)\r\n      .attr(\"y\", h)\r\n      .attr(\"fill\", function(d) {\r\n        return d.color;\r\n      });\r\n\r\n    gCandidatos\r\n      .selectAll(\"image\")\r\n      .transition()\r\n      .duration(2000)\r\n      .attr(\"opacity\", 0);\r\n\r\n    gCandidatos\r\n      .selectAll(\"text\")\r\n      .transition()\r\n      .duration(2000)\r\n      .attr(\"opacity\", 0);\r\n\r\n    mexico\r\n      .selectAll(\"path\")\r\n      .transition()\r\n      .duration(2000)\r\n      .attr(\"transform\", function(d) {\r\n        return \"translate(-310,90)\";\r\n      })\r\n      .style(\"stroke\", \"#ffffff\")\r\n      .style(\"stroke-width\", \"1px\");\r\n  }\r\n\r\n  function endall(transition, callback) {\r\n    var n = 0;\r\n    transition\r\n      .each(function() {\r\n        ++n;\r\n      })\r\n      .each(\"end\", function() {\r\n        if (!--n) callback.apply(this, arguments);\r\n      });\r\n  }\r\n\r\n  function generaTooltips() {\r\n    var opciones = {\r\n      trigger: \"custom\",\r\n      triggerOpen: {\r\n        mouseenter: true\r\n      },\r\n      triggerClose: {\r\n        mouseleave: true\r\n      },\r\n      contentAsHTML: true\r\n    };\r\n    svg.selectAll(\"path.estado\").each(function(d, i) {\r\n      var contenido =\r\n        \"<p>\" +\r\n        d.properties.NAME_1 +\r\n        \"<br>Candidato: \" +\r\n        d.properties.candidato.nombre +\r\n        \"</p>\";\r\n      opciones.content = $(contenido);\r\n      opciones.theme = \"tooltipster-borderless\";\r\n      $(this).tooltipster(opciones);\r\n    });\r\n  }\r\n\r\n  function descargaVisualizacion(elemento) {\r\n    var el = $(elemento).closest(\"div.visualizacion\");\r\n    var padre = d3\r\n      .select(el[0])\r\n      .node()\r\n      .cloneNode(true);\r\n    padre = d3.select(padre);\r\n    var svg = padre.select(\"svg\");\r\n    var nombreSVG = \"trendlecciones.svg\";\r\n    var nombrePNG = \"trendlecciones-mapa-barras.png\";\r\n    svg.attr(\"height\", medidas.alto + margin.top + margin.bottom);\r\n    svg.attr(\"width\", medidas.ancho + margin.left + margin.right);\r\n    var html = svg\r\n      .attr(\"title\", \"Trendlecciones\")\r\n      .attr(\"version\", 1.1)\r\n      .attr(\"xmlns\", \"http://www.w3.org/2000/svg\")\r\n      .attr(\"xmlns:xlink\", \"http://www.w3.org/1999/xlink\")\r\n      .node().parentNode.innerHTML;\r\n    html = unescape(encodeURIComponent(html));\r\n    var contenidoSVG = btoa(html);\r\n    var imageArtefacto = new Image();\r\n    imageArtefacto.width = medidas.ancho + margin.left + margin.right;\r\n    imageArtefacto.height = medidas.alto + margin.top + margin.bottom;\r\n    imageArtefacto.onload = function() {\r\n      var canvasArtefacto = document.createElement(\"canvas\");\r\n      canvasArtefacto.width = imageArtefacto.width;\r\n      canvasArtefacto.height = imageArtefacto.height;\r\n      canvasArtefacto.getContext(\"2d\").drawImage(imageArtefacto, 0, 0);\r\n      var contenidoPNG = canvasArtefacto.toDataURL(\"image/png\");\r\n      download(contenidoPNG, nombrePNG, \"image/png\");\r\n    };\r\n    imageArtefacto.src = \"data:image/svg+xml;base64,\" + contenidoSVG;\r\n  }\r\n\r\n  function convertImgToBase64URL(d, callback) {\r\n    var img = new Image();\r\n    //img.crossOrigin = \"Anonymous\";\r\n    img.onload = function() {\r\n      var canvas = document.createElement(\"CANVAS\"),\r\n        ctx = canvas.getContext(\"2d\"),\r\n        dataURL;\r\n      canvas.height = img.height;\r\n      canvas.width = img.width;\r\n      ctx.drawImage(img, 0, 0);\r\n      dataURL = canvas.toDataURL(\"image/png\");\r\n      d.imgb64 = dataURL;\r\n      canvas = null;\r\n      callback(null, d);\r\n    };\r\n    d.img = \"img/candidatos/\" + d.img;\r\n    img.src = d.img;\r\n  }\r\n\r\n  setup(el);\r\n\r\n  return { iniciar: iniciar };\r\n};\r\n","var MapaACartograma = function($, el, flagIniciar) {\r\n  flagIniciar = flagIniciar || false;\r\n  var flagEsp =\r\n    window.location.pathname.split(\"/\").indexOf(\"eng\") >= 0 ? false : true;\r\n\r\n  var margen = { superior: 20, derecho: 20, inferior: 20, izquierdo: 20 };\r\n  var medidas = {\r\n    ancho: 800 - (margen.derecho + margen.izquierdo),\r\n    alto: 800 - (margen.superior + margen.inferior)\r\n  };\r\n\r\n  var tarjeta = { ancho: 133, alto: 124 };\r\n  var offsetTarjeta = 24;\r\n  var retrato = { ancho: 85, alto: 85 };\r\n\r\n  var datosMexico = null;\r\n  var offsetMapa = { x: 450, y: 145 };\r\n\r\n  var estiloLeyenda = {\r\n    \"font-family\": \"'Roboto', sans-serif\",\r\n    \"font-size\": \"18px\",\r\n    \"font-style\": \"normal\",\r\n    \"text-anchor\": \"middle\",\r\n    \"alignment-baseline\": \"central\",\r\n    \"text-transform\": \"uppercase\",\r\n    \"font-kerning\": \"normal\"\r\n  };\r\n\r\n  var estiloPeriodo = {\r\n    \"font-family\": \"'Roboto', sans-serif\",\r\n    \"font-size\": \"18px\",\r\n    \"font-style\": \"normal\",\r\n    \"text-anchor\": \"middle\",\r\n    \"alignment-baseline\": \"central\",\r\n    \"text-transform\": \"uppercase\",\r\n    \"font-kerning\": \"normal\"\r\n  };\r\n\r\n  var datos = null;\r\n\r\n  var candidatos = null;\r\n\r\n  var porcentajesTotales = null;\r\n\r\n  var porcentajes = null;\r\n\r\n  var candidatoEnBlanco = { id: \"\", nombre: \"\", color: \"#000000\" };\r\n  var contenedor = null;\r\n  var svg = null;\r\n  var gLeyenda = null;\r\n  var gMexico = null;\r\n  var gSlider = null;\r\n  var rToggle = null;\r\n\r\n  var periodoTexto = null;\r\n\r\n  var idSombra = getGUID();\r\n  var idGris = getGUID();\r\n\r\n  var flagExplosion = false;\r\n\r\n  var escalaOpacidad = null;\r\n\r\n  var anchoMarcador = 101;\r\n  var inicioMedida = 22.5;\r\n  var anchoMedida = 707;\r\n  var medida = null;\r\n\r\n  var offsetMarcador = false;\r\n  var index = 0;\r\n\r\n  function setup(el) {\r\n    var elemento = null;\r\n    var flag = null;\r\n    contenedor = d3.select(el);\r\n    elemento = contenedor.node() || false;\r\n    if (elemento !== false) {\r\n      flag = contenedor.attr(\"data-visualizacion\") || false;\r\n      if (flag === false) {\r\n        contenedor.attr(\"data-visualizacion\", \"true\");\r\n        contenedor.classed(\"espera\", true);\r\n        contenedor.selectAll(\"svg\").remove();\r\n        svg = contenedor\r\n          .append(\"svg\")\r\n          .attr(\"preserveAspectRatio\", \"xMidYMid\")\r\n          .attr(\r\n            \"viewBox\",\r\n            \"0 0 \" +\r\n              (medidas.ancho + margen.derecho + margen.izquierdo) +\r\n              \" \" +\r\n              (medidas.alto + margen.superior + margen.inferior)\r\n          );\r\n\r\n        var defs = svg.append(\"defs\");\r\n        var filter = defs\r\n          .append(\"filter\")\r\n          .attr(\"id\", idSombra)\r\n          .attr(\"height\", \"130%\");\r\n\r\n        filter\r\n          .append(\"feGaussianBlur\")\r\n          .attr(\"in\", \"SourceAlpha\")\r\n          .attr(\"stdDeviation\", \"2\");\r\n\r\n        filter\r\n          .append(\"feOffset\")\r\n          .attr(\"dx\", \"2\")\r\n          .attr(\"dy\", \"2\")\r\n          .attr(\"result\", \"offsetblur\");\r\n\r\n        filter\r\n          .append(\"feFlood\")\r\n          .attr(\"flood-color\", \"rgb(0,0,0)\")\r\n          .attr(\"flood-opacity\", \"0.2\");\r\n\r\n        filter\r\n          .append(\"feComposite\")\r\n          .attr(\"in2\", \"offsetblur\")\r\n          .attr(\"operator\", \"in\");\r\n\r\n        var feMerge = filter.append(\"feMerge\");\r\n        feMerge.append(\"feMergeNode\");\r\n        feMerge.append(\"feMergeNode\").attr(\"in\", \"SourceGraphic\");\r\n\r\n        defs\r\n          .append(\"filter\")\r\n          .attr(\"id\", idGris)\r\n          .append(\"feColorMatrix\")\r\n          .attr(\"type\", \"matrix\")\r\n          .attr(\r\n            \"values\",\r\n            \"0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\"\r\n          );\r\n\r\n        svg\r\n          .append(\"rect\")\r\n          .attr(\"fill\", \"#ffffff\")\r\n          .attr(\"x\", 0)\r\n          .attr(\"y\", 0)\r\n          .attr(\"width\", medidas.ancho + margen.izquierdo + margen.derecho)\r\n          .attr(\"height\", medidas.alto + margen.superior + margen.inferior);\r\n\r\n        svg = svg\r\n          .append(\"g\")\r\n          .attr(\r\n            \"transform\",\r\n            \"translate(\" + margen.izquierdo + \",\" + margen.derecho + \")\"\r\n          );\r\n\r\n        svg\r\n          .append(\"rect\")\r\n          .attr(\"class\", \"remover\")\r\n          .attr(\"width\", medidas.ancho)\r\n          .attr(\"height\", medidas.alto)\r\n          .attr(\"fill\", \"transparent\");\r\n\r\n        rToggle = svg\r\n          .append(\"rect\")\r\n          .attr(\"class\", \"cursor\")\r\n          .attr(\"x\", 0)\r\n          .attr(\"y\", 130)\r\n          .attr(\"width\", medidas.ancho)\r\n          .attr(\"height\", 530)\r\n          .attr(\"fill\", \"transparent\");\r\n\r\n        periodoTexto = svg\r\n          .append(\"g\")\r\n          .attr(\"transform\", \"translate(0,682)\")\r\n          .append(\"text\")\r\n          .attr(\"x\", medidas.ancho / 2)\r\n          .style(estiloPeriodo);\r\n\r\n        gLeyenda = svg.append(\"g\");\r\n        gMexico = svg\r\n          .append(\"g\")\r\n          .style(\"stroke\", \"#ffffff\")\r\n          .attr(\"transform\", \"translate(-150,150)\");\r\n        gSlider = svg\r\n          .append(\"g\")\r\n          .attr(\"transform\", \"translate(0,\" + (medidas.alto - 60) + \")\");\r\n\r\n        escalaOpacidad = d3.scale\r\n          .linear()\r\n          .domain([0, 100])\r\n          .range([0.2, 1]);\r\n\r\n        var descarga = $(elemento)\r\n          .closest(\"div.visualizacion\")\r\n          .next()\r\n          .next()\r\n          .find(\"img[alt=download]\")\r\n          .closest(\"a\");\r\n        if (descarga.length === 0) {\r\n          descarga = $(elemento)\r\n            .closest(\"div.visualizacion\")\r\n            .closest(\"section\")\r\n            .find(\"img[alt=download]\")\r\n            .closest(\"a\");\r\n        }\r\n        if (descarga.length !== 0) {\r\n          descarga.attr(\"href\", \"#\").click(function(event) {\r\n            event.preventDefault();\r\n            event.stopPropagation();\r\n            descargaVisualizacion(elemento);\r\n          });\r\n        }\r\n\r\n        main();\r\n      }\r\n    }\r\n  }\r\n\r\n  function main() {\r\n    var projection = d3.geo\r\n      .mercator()\r\n      .scale(1500)\r\n      .center([-103.84034978813841, 24.012062015793]);\r\n    var path = d3.geo.path().projection(projection);\r\n    var q = d3.queue();\r\n    var urlValoresJSON = contenedor.attr(\"data-valores-json\") || false;\r\n    var urlCandidatos = contenedor.attr(\"data-candidatos\") || false;\r\n    if (urlCandidatos !== false && urlValoresJSON !== false) {\r\n      q.defer(d3.json, \"json/mexico.json\");\r\n      q.defer(d3.json, \"json/estados-cartograma.json\");\r\n      q.defer(d3.json, urlCandidatos + \"?\" + getGUID());\r\n      q.defer(d3.json, urlValoresJSON + \"?\" + getGUID());\r\n      q.awaitAll(function(error, arreglo) {\r\n        datosMexico = arreglo[0];\r\n        datos = arreglo[1];\r\n        candidatos = arreglo[2];\r\n        porcentajesTotales = arreglo[3];\r\n        var f = d3.queue();\r\n        _.each(candidatos, function(candidato) {\r\n          f.defer(convertImgToBase64URL, candidato);\r\n        });\r\n        f.awaitAll(function(error, a) {\r\n          candidatos.sort(function(a, b) {\r\n            if (a.nombrecorto < b.nombrecorto) {\r\n              return -1;\r\n            }\r\n            if (a.nombrecorto > b.nombrecorto) {\r\n              return 1;\r\n            }\r\n            return 0;\r\n          });\r\n          resetCandidatos();\r\n          generaLeyenda();\r\n          procesaDatos();\r\n          generaMexico(path);\r\n          generaSliderTemporal();\r\n          generaTooltips();\r\n          iniciaEventos();\r\n          contenedor.classed(\"espera\", false);\r\n          if (flagIniciar === true) {\r\n            iniciar();\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  function iniciar() {\r\n    setPorcentajes(0);\r\n    setCandidatoSeleccionado(candidatos[0].id);\r\n    actualizaTooltips();\r\n    explotaMexico();\r\n    periodoTexto.text(\r\n      flagEsp ? porcentajesTotales[0].nombre : porcentajesTotales[0].nombrei\r\n    );\r\n  }\r\n\r\n  function generaLeyenda() {\r\n    var ancho =\r\n      tarjeta.ancho * candidatos.length +\r\n      offsetTarjeta * (candidatos.length - 1);\r\n    var offsetX = (medidas.ancho - ancho) / 2;\r\n    gLeyenda.attr(\"transform\", \"translate(\" + offsetX + \",0)\");\r\n\r\n    var grupos = gLeyenda\r\n      .selectAll(\"g\")\r\n      .data(candidatos)\r\n      .enter()\r\n      .append(\"g\")\r\n      .attr(\"fill\", function(d) {\r\n        return d.color;\r\n      })\r\n      .attr(\"transform\", function(d, i) {\r\n        return \"translate(\" + i * (tarjeta.ancho + offsetTarjeta) + \",0)\";\r\n      });\r\n\r\n    grupos\r\n      .append(\"rect\")\r\n      .attr(\"x\", 0)\r\n      .attr(\"y\", 0)\r\n      .attr(\"class\", \"cursor\")\r\n      .attr(\"width\", tarjeta.ancho)\r\n      .attr(\"height\", tarjeta.alto)\r\n      .attr(\"fill\", \"#ffffff\")\r\n      .style(\"filter\", \"url(#\" + idSombra + \")\");\r\n\r\n    grupos\r\n      .append(\"svg:image\")\r\n      .attr(\"class\", \"cursor\")\r\n      .attr(\"x\", (tarjeta.ancho - retrato.ancho) / 2)\r\n      .attr(\"y\", 10)\r\n      .attr(\"width\", retrato.ancho)\r\n      .attr(\"height\", retrato.alto)\r\n      .attr(\"xlink:href\", function(d) {\r\n        return d.imgb64;\r\n      })\r\n      .attr(\"fill\", \"transparent\");\r\n\r\n    grupos\r\n      .append(\"text\")\r\n      .text(function(d) {\r\n        return d.nombrecorto;\r\n      })\r\n      .style(\"stroke\", function(d) {\r\n        return d.color;\r\n      })\r\n      .style(\"fill\", function(d) {\r\n        return d.color;\r\n      })\r\n      .style(estiloLeyenda)\r\n      .attr(\"x\", tarjeta.ancho / 2)\r\n      .attr(\"y\", retrato.alto + 30);\r\n  }\r\n\r\n  function setPorcentajes(numero) {\r\n    numero = numero >= porcentajesTotales.length ? 0 : numero;\r\n    var obj = porcentajesTotales[numero];\r\n    var candidato = getCandidatoSeleccionado();\r\n    if (obj !== false) {\r\n      var pcts = obj.valores;\r\n      var obj = {};\r\n      _.each(candidatos, function(c) {\r\n        obj[c.id] = {};\r\n      });\r\n      _.each(pcts, function(o, c) {\r\n        _.each(candidatos, function(candidato) {\r\n          obj[candidato.id][c] = o[candidato.id];\r\n        });\r\n      });\r\n      porcentajes = obj;\r\n      gMexico\r\n        .selectAll(\"path\")\r\n        .each(function(d) {\r\n          d.properties.datos.opacidad = getPorcentaje(\r\n            d.properties.datos.candidato,\r\n            d.properties.ID_1\r\n          );\r\n        })\r\n        .transition()\r\n        .duration(1000)\r\n        .attr(\"fill\", function(d) {\r\n          return getColor(d);\r\n        })\r\n        .attr(\"opacity\", function(d) {\r\n          var opacidad = 1;\r\n          opacidad = d.properties.datos.opacidad;\r\n          return opacidad;\r\n        });\r\n    }\r\n  }\r\n\r\n  function resetCandidatos() {\r\n    _.each(candidatos, function(c) {\r\n      c.seleccionado = false;\r\n    });\r\n  }\r\n\r\n  function getCandidatoSeleccionado() {\r\n    var c = null;\r\n    c = _.find(candidatos, { seleccionado: true });\r\n    c = c || false;\r\n    return c === false ? candidatoEnBlanco : c;\r\n  }\r\n\r\n  function getPorcentaje(candidato, cadenaEstado) {\r\n    var porcentaje = 1;\r\n    if (candidato.nombre !== \"\") {\r\n      var valor = porcentajes[candidato.id][cadenaEstado];\r\n      if (valor != 0) {\r\n        porcentaje = escalaOpacidad(valor);\r\n      }\r\n    }\r\n    return porcentaje;\r\n  }\r\n\r\n  function procesaDatos() {\r\n    var candidato = getCandidatoSeleccionado();\r\n    _.each(datos, function(d) {\r\n      d.x = +d.x + offsetMapa.x;\r\n      d.y = +d.y + offsetMapa.y;\r\n      d.escala = +d.area;\r\n      d.id = +d.id;\r\n    });\r\n    var propiedades = _.map(\r\n      datosMexico.objects.mexico.geometries,\r\n      \"properties\"\r\n    );\r\n    _.each(propiedades, function(p) {\r\n      var d =\r\n        _.find(datos, {\r\n          id: p.ID_1\r\n        }) || false;\r\n      if (d !== false) {\r\n        p.datos = {};\r\n        p.datos.ajuste = { x: d.x, y: d.y };\r\n        p.datos.centroide = { x: 0, y: 0 };\r\n        p.datos.estado = d.estado;\r\n        p.datos.escala = d.escala;\r\n        p.datos.candidato = candidato;\r\n        p.datos.opacidad = getPorcentaje(candidato, d.id);\r\n      }\r\n    });\r\n  }\r\n\r\n  function generaMexico(path) {\r\n    gMexico\r\n      .selectAll(\"path\")\r\n      .data(topojson.feature(datosMexico, datosMexico.objects.mexico).features)\r\n      .enter()\r\n      .append(\"path\")\r\n      .each(function(d) {\r\n        var centroid = path.centroid(d);\r\n        d.properties.datos.centroide.x = centroid[0];\r\n        d.properties.datos.centroide.y = centroid[1];\r\n      })\r\n      .attr(\"d\", path)\r\n      .attr(\"fill\", \"#000000\")\r\n      .style(\"stroke-width\", \"1px\");\r\n  }\r\n\r\n  function generaSliderTemporal() {\r\n    var drag = d3.behavior\r\n      .drag()\r\n      .on(\"dragstart\", dragstarted)\r\n      .on(\"drag\", dragged)\r\n      .on(\"dragend\", dragended);\r\n\r\n    var fondo = gSlider\r\n      .append(\"rect\")\r\n      .attr(\"fill\", \"white\")\r\n      .attr(\"x\", 0)\r\n      .attr(\"y\", 0)\r\n      .attr(\"width\", 760)\r\n      .attr(\"height\", 60)\r\n      .style(\"filter\", \"url(#\" + idSombra + \")\");\r\n\r\n    var medidaCompleta = gSlider\r\n      .append(\"rect\")\r\n      .attr(\"fill\", \"#cdcdcd\")\r\n      .attr(\"x\", inicioMedida)\r\n      .attr(\"y\", 20)\r\n      .attr(\"width\", anchoMedida)\r\n      .attr(\"height\", 20);\r\n\r\n    medida = gSlider\r\n      .append(\"rect\")\r\n      .attr(\"fill\", \"grey\")\r\n      .attr(\"x\", inicioMedida)\r\n      .attr(\"y\", 20)\r\n      .attr(\"width\", anchoMarcador / 2)\r\n      .attr(\"height\", 20)\r\n      .attr(\"class\", \"ignorar\");\r\n\r\n    var marcador = gSlider\r\n      .append(\"rect\")\r\n      .attr(\"fill\", \"#000000\")\r\n      .attr(\"x\", 300 + inicioMedida - anchoMarcador / 2)\r\n      .attr(\"x\", inicioMedida)\r\n      .attr(\"y\", 10)\r\n      .attr(\"rx\", 10)\r\n      .attr(\"ry\", 10)\r\n      .attr(\"width\", 101)\r\n      .attr(\"height\", 40)\r\n      .attr(\"class\", \"arrastrar marcador\")\r\n      .call(drag);\r\n  }\r\n\r\n  function dragstarted() {\r\n    d3.event.sourceEvent.stopPropagation();\r\n    offsetMarcador = false;\r\n    d3.select(this).attr(\"class\", \"arrastrando marcador\");\r\n  }\r\n\r\n  function dragged() {\r\n    var x = d3.event.x;\r\n    var marcador = d3.select(this);\r\n    ajustaMarcador(marcador, x);\r\n  }\r\n\r\n  function dragended() {\r\n    offsetMarcador = false;\r\n    setPorcentajes(index);\r\n    d3.select(this).attr(\"class\", \"arrastrar marcador\");\r\n    actualizaTooltips();\r\n  }\r\n\r\n  function ajustaMarcador(rect, x) {\r\n    var total = anchoMedida - anchoMarcador;\r\n    var anchoSegmento = total / porcentajesTotales.length;\r\n    if (offsetMarcador === false) {\r\n      offsetMarcador = x - rect.attr(\"x\");\r\n    }\r\n    var nx = x - offsetMarcador;\r\n    nx = nx <= inicioMedida ? inicioMedida : nx;\r\n    nx =\r\n      nx >= anchoMedida + inicioMedida - anchoMarcador\r\n        ? anchoMedida + inicioMedida - anchoMarcador\r\n        : nx;\r\n    medida.attr(\"width\", nx - inicioMedida + anchoMarcador / 2);\r\n    rect.attr(\"x\", nx);\r\n    var pos = nx - inicioMedida;\r\n\r\n    index = parseInt(pos / anchoSegmento);\r\n    index =\r\n      index >= porcentajesTotales.length\r\n        ? porcentajesTotales.length - 1\r\n        : index;\r\n    periodoTexto.text(\r\n      flagEsp\r\n        ? porcentajesTotales[index].nombre\r\n        : porcentajesTotales[index].nombrei\r\n    );\r\n  }\r\n\r\n  function generaTooltips() {\r\n    var opciones = {\r\n      trigger: \"custom\",\r\n      triggerOpen: {\r\n        mouseenter: true,\r\n        touchstart: true\r\n      },\r\n      triggerClose: {\r\n        mouseleave: true,\r\n        tap: true\r\n      },\r\n      contentAsHTML: true\r\n    };\r\n    gMexico.selectAll(\"path\").each(function(d, i) {\r\n      var contenido = \"<p>\" + d.properties.datos.estado + \"</p>\";\r\n      opciones.content = $(contenido);\r\n      opciones.theme = \"tooltipster-borderless\";\r\n      $(this).tooltipster(opciones);\r\n    });\r\n  }\r\n\r\n  function explotaMexico() {\r\n    flagExplosion = true;\r\n    gMexico\r\n      .selectAll(\"path\")\r\n      .transition()\r\n      .duration(1000)\r\n      .attr(\"transform\", function(d) {\r\n        return (\r\n          \"translate(\" +\r\n          d.properties.datos.ajuste.x +\r\n          \",\" +\r\n          d.properties.datos.ajuste.y +\r\n          \") scale (\" +\r\n          1 / 3 +\r\n          \") translate(\" +\r\n          d.properties.datos.centroide.x +\r\n          \",\" +\r\n          d.properties.datos.centroide.y +\r\n          \") scale(\" +\r\n          d.properties.datos.escala +\r\n          \") translate(\" +\r\n          -d.properties.datos.centroide.x +\r\n          \",\" +\r\n          -d.properties.datos.centroide.y +\r\n          \")\"\r\n        );\r\n      })\r\n      .attr(\"fill\", function(d) {\r\n        return getColor(d);\r\n      })\r\n      .attr(\"opacity\", function(d) {\r\n        return d.properties.datos.opacidad;\r\n      })\r\n      .style(\"stroke-width\", function(d) {\r\n        return 1 / d.properties.datos.escala + \"px\";\r\n      });\r\n  }\r\n\r\n  function juntaMexico() {\r\n    flagExplosion = false;\r\n    gMexico\r\n      .selectAll(\"path\")\r\n      .transition()\r\n      .duration(1000)\r\n      .attr(\"transform\", \"translate(0,0)\")\r\n      .attr(\"fill\", function(d) {\r\n        return getColor(d);\r\n      })\r\n      .style(\"stroke-width\", \"1px\");\r\n  }\r\n\r\n  function setCandidatoSeleccionado(cadena) {\r\n    var c = null;\r\n    resetCandidatos();\r\n    c = _.find(candidatos, { id: cadena }) || false;\r\n    if (c !== false) {\r\n      c.seleccionado = true;\r\n\r\n      gLeyenda\r\n        .selectAll(\"g\")\r\n        .transition()\r\n        .duration(1000)\r\n        .style(\"opacity\", function(d) {\r\n          return d.seleccionado === true ? 1 : 0.3;\r\n        })\r\n        .call(endall, candidatosAGris);\r\n\r\n      gLeyenda\r\n        .selectAll(\"text\")\r\n        .transition()\r\n        .duration(1000)\r\n        .style(\"fill\", function(d) {\r\n          return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n        })\r\n        .style(\"stroke\", function(d) {\r\n          return d.seleccionado === true ? d.color : \"#cdcdcd\";\r\n        });\r\n\r\n      gMexico\r\n        .selectAll(\"path\")\r\n        .each(function(d) {\r\n          d.properties.datos.candidato = c;\r\n          d.properties.datos.opacidad = getPorcentaje(c, d.properties.ID_1);\r\n        })\r\n        .transition()\r\n        .duration(1000)\r\n        .attr(\"fill\", function(d) {\r\n          return getColor(d);\r\n        })\r\n        .attr(\"opacity\", function(d) {\r\n          return d.properties.datos.opacidad;\r\n        });\r\n    } else {\r\n      c = candidatoEnBlanco;\r\n    }\r\n    return c;\r\n  }\r\n\r\n  function getColor(d) {\r\n    var color = \"#dfe0e1\";\r\n    if (porcentajes.hasOwnProperty(d.properties.datos.candidato.id)) {\r\n      if (\r\n        porcentajes[d.properties.datos.candidato.id][d.properties.ID_1] !== 0\r\n      ) {\r\n        color = d.properties.datos.candidato.color;\r\n      }\r\n    }\r\n    return color;\r\n  }\r\n\r\n  function toggleMexico() {\r\n    if (flagExplosion === false) {\r\n      explotaMexico();\r\n    } else {\r\n      juntaMexico();\r\n    }\r\n  }\r\n\r\n  function toggleCandidato(d) {\r\n    setCandidatoSeleccionado(d.id);\r\n    actualizaTooltips();\r\n  }\r\n\r\n  function actualizaTooltips() {\r\n    gMexico.selectAll(\"path\").each(function(d) {\r\n      var pct = porcentajes[d.properties.datos.candidato.id][d.properties.ID_1];\r\n      var contenido = \"<p>\" + pct + \"<br>\" + d.properties.datos.estado + \"</p>\";\r\n      $(this).tooltipster(\"content\", contenido);\r\n    });\r\n  }\r\n\r\n  function iniciaEventos() {\r\n    var el = $(contenedor.node());\r\n    rToggle.on(\"click\", toggleMexico);\r\n    gLeyenda.selectAll(\".cursor\").on(\"click\", toggleCandidato);\r\n  }\r\n\r\n  function getGUID() {\r\n    return (\r\n      Date.now().toString(36) +\r\n      Math.random()\r\n        .toString(36)\r\n        .substr(2, 5)\r\n    ).toUpperCase();\r\n  }\r\n\r\n  function candidatosAGris() {\r\n    gLeyenda\r\n      .selectAll(\"image\")\r\n      .transition()\r\n      .duration(1000)\r\n      .style(\"filter\", function(d, i) {\r\n        return d.seleccionado === true ? \"\" : \"url(#\" + idGris + \")\";\r\n      });\r\n  }\r\n\r\n  function endall(transition, callback) {\r\n    var n = 0;\r\n    transition\r\n      .each(function() {\r\n        ++n;\r\n      })\r\n      .each(\"end\", function() {\r\n        if (!--n) callback.apply(this, arguments);\r\n      });\r\n  }\r\n\r\n  function descargaVisualizacion(elemento) {\r\n    var el = $(elemento).closest(\"div.visualizacion\");\r\n    var padre = d3\r\n      .select(el[0])\r\n      .node()\r\n      .cloneNode(true);\r\n    padre = d3.select(padre);\r\n    var svg = padre.select(\"svg\");\r\n    var nombreSVG = \"trendlecciones.svg\";\r\n    var nombrePNG = \"trendlecciones-mapa-cartograma.png\";\r\n    svg.attr(\"height\", medidas.alto + margen.superior + margen.inferior);\r\n    svg.attr(\"width\", medidas.ancho + margen.izquierdo + margen.derecho);\r\n    var html = svg\r\n      .attr(\"title\", \"Trendlecciones\")\r\n      .attr(\"version\", 1.1)\r\n      .attr(\"xmlns\", \"http://www.w3.org/2000/svg\")\r\n      .attr(\"xmlns:xlink\", \"http://www.w3.org/1999/xlink\")\r\n      .node().parentNode.innerHTML;\r\n    html = unescape(encodeURIComponent(html));\r\n    var contenidoSVG = btoa(html);\r\n    var imageArtefacto = new Image();\r\n    imageArtefacto.width = medidas.ancho + margen.izquierdo + margen.derecho;\r\n    imageArtefacto.height = medidas.alto + margen.superior + margen.inferior;\r\n    imageArtefacto.onload = function() {\r\n      var canvasArtefacto = document.createElement(\"canvas\");\r\n      canvasArtefacto.width = imageArtefacto.width;\r\n      canvasArtefacto.height = imageArtefacto.height;\r\n      canvasArtefacto.getContext(\"2d\").drawImage(imageArtefacto, 0, 0);\r\n      var contenidoPNG = canvasArtefacto.toDataURL(\"image/png\");\r\n      download(contenidoPNG, nombrePNG, \"image/png\");\r\n    };\r\n    imageArtefacto.src = \"data:image/svg+xml;base64,\" + contenidoSVG;\r\n  }\r\n\r\n  function convertImgToBase64URL(d, callback) {\r\n    var img = new Image();\r\n    //img.crossOrigin = \"Anonymous\";\r\n    img.onload = function() {\r\n      var canvas = document.createElement(\"CANVAS\"),\r\n        ctx = canvas.getContext(\"2d\"),\r\n        dataURL;\r\n      canvas.height = img.height;\r\n      canvas.width = img.width;\r\n      ctx.drawImage(img, 0, 0);\r\n      dataURL = canvas.toDataURL(\"image/png\");\r\n      d.imgb64 = dataURL;\r\n      canvas = null;\r\n      callback(null, d);\r\n    };\r\n    d.img = \"img/candidatos/\" + d.img;\r\n    img.src = d.img;\r\n  }\r\n\r\n  setup(el);\r\n\r\n  return { iniciar: iniciar };\r\n};\r\n","var NubeDePalabras = function($, el, flagIniciar) {\r\n  flagIniciar = flagIniciar || false;\r\n  var flagEsp =\r\n    window.location.pathname.split(\"/\").indexOf(\"eng\") >= 0 ? false : true;\r\n\r\n  var margen = { superior: 20, derecho: 20, inferior: 20, izquierdo: 20 };\r\n  var medidas = {\r\n    ancho: 800 - (margen.derecho + margen.izquierdo),\r\n    alto: 800 - (margen.superior + margen.inferior)\r\n  };\r\n\r\n  var retratos = { ancho: 150, alto: 150 };\r\n  var paddingRetratos = 40;\r\n\r\n  var retratosGrandes = { ancho: 105, alto: 105 };\r\n\r\n  var marcos = { ancho: 164 };\r\n  var paddingMarcos = 24;\r\n\r\n  var candidatos = [];\r\n\r\n  var candidato = false;\r\n\r\n  var palabras = [];\r\n\r\n  var estiloBoton = {\r\n    \"font-family\": \"'Roboto', sans-serif\",\r\n    \"font-size\": \"18px\",\r\n    \"font-style\": \"normal\",\r\n    \"text-anchor\": \"middle\",\r\n    \"dominant-baseline\": \"central\",\r\n    \"text-transform\": \"uppercase\",\r\n    \"font-kerning\": \"normal\",\r\n    fill: \"#ffffff\",\r\n    \"pointer-events\": \"none\"\r\n  };\r\n\r\n  var tamanios = {\r\n    0: 23,\r\n    1: 23,\r\n    2: 21,\r\n    3: 21,\r\n    4: 19,\r\n    5: 19,\r\n    6: 17,\r\n    7: 17,\r\n    8: 15,\r\n    9: 15\r\n  };\r\n\r\n  var pesos = {\r\n    0: 900,\r\n    1: 900,\r\n    2: 700,\r\n    3: 700,\r\n    4: 500,\r\n    5: 500,\r\n    6: 400,\r\n    7: 400,\r\n    8: 300,\r\n    9: 300\r\n  };\r\n\r\n  var negros = {\r\n    0: \"#000000\",\r\n    1: \"#000000\",\r\n    2: \"#414042\",\r\n    3: \"#414042\",\r\n    4: \"#58595b\",\r\n    5: \"#58595b\",\r\n    6: \"#6d6e71\",\r\n    7: \"#6d6e71\",\r\n    8: \"#808285\",\r\n    9: \"#808285\"\r\n  };\r\n\r\n  var candidatoEnBlanco = { id: \"\", nombre: \"\", color: \"#000000\" };\r\n  var contenedor = null;\r\n  var svg = null;\r\n  var gFondo = null;\r\n\r\n  var gFondoNube = null;\r\n  var gPalabras = null;\r\n\r\n  var gFondoListas = null;\r\n  var gMarcos = null;\r\n  var gListas = null;\r\n\r\n  var gBoton = null;\r\n\r\n  var idSombra = getGUID();\r\n  var flagBoton = false;\r\n  var medidasBoton = { ancho: 171, alto: 68 };\r\n\r\n  var escalaOpacidad = d3.scale.linear().range([0, 100]);\r\n  var escalaTamanio = d3.scale.linear().range([10, 24]);\r\n  var force = d3.layout\r\n    .force()\r\n    .size([medidas.ancho, medidas.alto / 3])\r\n    .linkDistance(100)\r\n    .linkStrength(1);\r\n\r\n  var arrastre = force\r\n    .drag()\r\n    .on(\"dragstart\", dragstart)\r\n    .on(\"dragend\", dragend)\r\n    .on(\"drag\", drag);\r\n\r\n  var nodos = [];\r\n  var enlaces = [];\r\n\r\n  function dragstart(n) {\r\n    if (n.principal === true) {\r\n      if (n.principal === true && n.candidato.id !== candidato.id) {\r\n        gPalabras\r\n          .selectAll(\"text\")\r\n          .filter(function(d) {\r\n            return d.principal === false;\r\n          })\r\n          .transition()\r\n          .duration(1000)\r\n          .style(\"fill\", function(d) {\r\n            return negros[d.orden];\r\n          })\r\n          .attr(\"opacity\", 1)\r\n          .style(\"font-size\", function(d, i) {\r\n            return tamanios[d.orden] + \"px\";\r\n          });\r\n\r\n        enlaces = [];\r\n        force\r\n          .links(enlaces)\r\n          .charge(-30)\r\n          .start();\r\n      }\r\n      setCandidatoSeleccionado(n.candidato.id);\r\n      gPalabras\r\n        .selectAll(\"g.etiqueta\")\r\n        .filter(function(d) {\r\n          return d.candidato.id !== n.candidato.id && d.principal === true;\r\n        })\r\n        .transition()\r\n        .duration(1000)\r\n        .attr(\"transform\", function(d) {\r\n          return (\r\n            \"translate(\" +\r\n            d.candidato.coords.x +\r\n            \",\" +\r\n            d.candidato.coords.y +\r\n            \")\"\r\n          );\r\n        })\r\n        .each(\"end\", function(d) {\r\n          d.x = d.candidato.coords.x;\r\n          d.px = d.candidato.coords.x;\r\n          d.y = d.candidato.coords.y;\r\n          d.py = d.candidato.coords.y;\r\n        });\r\n    }\r\n  }\r\n\r\n  function dragend(n) {\r\n    if (n.principal === true) {\r\n      if (n.force === false) {\r\n        var nt =\r\n          gPalabras.selectAll(\"g.etiqueta\").filter(function(d) {\r\n            return d.principal === true && d.candidato.seleccionado === true;\r\n          }) || false;\r\n        if (nt !== false) {\r\n          nt.transition()\r\n            .duration(1000)\r\n            .attr(\"transform\", function(d) {\r\n              return (\r\n                \"translate(\" +\r\n                d.candidato.coords.x +\r\n                \",\" +\r\n                d.candidato.coords.y +\r\n                \")\"\r\n              );\r\n            })\r\n            .each(\"end\", function(d) {\r\n              d.candidato.seleccionado = false;\r\n              d.x = d.candidato.coords.x;\r\n              d.px = d.candidato.coords.x;\r\n              d.y = d.candidato.coords.y;\r\n              d.py = d.candidato.coords.y;\r\n            });\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  function drag(n) {\r\n    if (n.principal === true && n.force === false && n.y >= -100) {\r\n      n.force = true;\r\n      var nodosSecundarios = _.filter(nodos, function(ns) {\r\n        return ns.candidato.id === n.candidato.id && ns.principal === false;\r\n      });\r\n      _.each(nodosSecundarios, function(ns) {\r\n        enlaces.push({ source: n, target: ns });\r\n      });\r\n      gPalabras\r\n        .selectAll(\"text\")\r\n        .filter(function(d) {\r\n          return d.principal === false;\r\n        })\r\n        .transition()\r\n        .duration(1000)\r\n        .style(\"fill\", function(d) {\r\n          if (d.candidato.id === n.id) {\r\n            return d.candidato.color;\r\n          } else {\r\n            return negros[d.orden];\r\n          }\r\n        })\r\n        .attr(\"opacity\", function(d) {\r\n          if (d.candidato.id === n.id) {\r\n            return 1;\r\n          } else {\r\n            return 0;\r\n          }\r\n        })\r\n        .style(\"font-size\", function(d, i) {\r\n          if (d.candidato.id === n.id) {\r\n            return tamanios[d.orden] + 5 + \"px\";\r\n          } else {\r\n            return tamanios[d.orden] + \"px\";\r\n          }\r\n        });\r\n      force\r\n        .links(enlaces)\r\n        .charge(function(n) {\r\n          var charge = -500;\r\n          if (n.principal === 0) charge = 10 * charge;\r\n          return charge;\r\n        })\r\n        .start();\r\n    }\r\n    if (n.principal === true && n.force === true && n.y < -100) {\r\n      gPalabras\r\n        .selectAll(\"text\")\r\n        .transition()\r\n        .duration(1000)\r\n        .style(\"fill\", function(d) {\r\n          return negros[d.orden];\r\n        })\r\n        .attr(\"opacity\", 1);\r\n      n.force = false;\r\n      enlaces = [];\r\n      force\r\n        .links(enlaces)\r\n        .charge(-30)\r\n        .start();\r\n    }\r\n  }\r\n\r\n  function setup(el) {\r\n    var elemento = null;\r\n    var flag = null;\r\n    contenedor = d3.select(el);\r\n    elemento = contenedor.node() || false;\r\n    if (elemento !== false) {\r\n      flag = contenedor.attr(\"data-visualizacion\") || false;\r\n      if (flag === false) {\r\n        contenedor.attr(\"data-visualizacion\", \"true\");\r\n        contenedor.classed(\"espera\", true);\r\n        contenedor.selectAll(\"svg\").remove();\r\n        svg = contenedor\r\n          .append(\"svg\")\r\n          .attr(\"preserveAspectRatio\", \"xMidYMid\")\r\n          .attr(\r\n            \"viewBox\",\r\n            \"0 0 \" +\r\n              (medidas.ancho + margen.derecho + margen.izquierdo) +\r\n              \" \" +\r\n              (medidas.alto + margen.superior + margen.inferior)\r\n          );\r\n\r\n        var defs = svg.append(\"defs\");\r\n        var filter = defs\r\n          .append(\"filter\")\r\n          .attr(\"id\", idSombra)\r\n          .attr(\"height\", \"130%\");\r\n\r\n        filter\r\n          .append(\"feGaussianBlur\")\r\n          .attr(\"in\", \"SourceAlpha\")\r\n          .attr(\"stdDeviation\", \"2\");\r\n\r\n        filter\r\n          .append(\"feOffset\")\r\n          .attr(\"dx\", \"2\")\r\n          .attr(\"dy\", \"2\")\r\n          .attr(\"result\", \"offsetblur\");\r\n\r\n        filter\r\n          .append(\"feFlood\")\r\n          .attr(\"flood-color\", \"rgb(0,0,0)\")\r\n          .attr(\"flood-opacity\", \"0.2\");\r\n\r\n        filter\r\n          .append(\"feComposite\")\r\n          .attr(\"in2\", \"offsetblur\")\r\n          .attr(\"operator\", \"in\");\r\n\r\n        var feMerge = filter.append(\"feMerge\");\r\n        feMerge.append(\"feMergeNode\");\r\n        feMerge.append(\"feMergeNode\").attr(\"in\", \"SourceGraphic\");\r\n\r\n        svg\r\n          .append(\"rect\")\r\n          .attr(\"fill\", \"#ffffff\")\r\n          .attr(\"x\", 0)\r\n          .attr(\"y\", 0)\r\n          .attr(\"width\", medidas.ancho + margen.izquierdo + margen.derecho)\r\n          .attr(\"height\", medidas.alto + margen.superior + margen.inferior);\r\n\r\n        var testSVG = svg;\r\n\r\n        svg = svg\r\n          .append(\"g\")\r\n          .attr(\r\n            \"transform\",\r\n            \"translate(\" + margen.izquierdo + \",\" + margen.derecho + \")\"\r\n          );\r\n\r\n        svg\r\n          .append(\"rect\")\r\n          .attr(\"width\", medidas.ancho)\r\n          .attr(\"height\", medidas.alto)\r\n          .attr(\"fill\", \"#ffffff\");\r\n\r\n        gFondo = svg\r\n          .append(\"g\")\r\n          .attr(\"transform\", \"translate(0,\" + medidas.alto / 2 + \")\");\r\n        gFondo\r\n          .append(\"rect\")\r\n          .attr(\"height\", medidas.alto / 2)\r\n          .attr(\"width\", medidas.ancho)\r\n          .attr(\"fill\", \"#ffffff\");\r\n\r\n        gFondoNube = svg\r\n          .append(\"g\")\r\n          .attr(\"opacity\", 1)\r\n          .attr(\"class\", \"simultaneo\")\r\n          .datum({ tipo: \"nube\" });\r\n\r\n        gPalabras = gFondoNube\r\n          .append(\"g\")\r\n          .attr(\"transform\", \"translate(0,\" + medidas.alto / 2 + \")\");\r\n\r\n        gFondoListas = svg\r\n          .append(\"g\")\r\n          .attr(\"opacity\", 0)\r\n          .attr(\"class\", \"ignorar simultaneo\")\r\n          .datum({ tipo: \"lista\" });\r\n\r\n        gFondoListas\r\n          .append(\"rect\")\r\n          .attr(\"fill\", \"#ffffff\")\r\n          .attr(\"x\", -margen.derecho)\r\n          .attr(\"y\", -margen.superior)\r\n          .attr(\"width\", medidas.ancho + margen.izquierdo + margen.derecho)\r\n          .attr(\"height\", medidas.alto + margen.superior + margen.inferior);\r\n\r\n        gFondoListas\r\n          .append(\"rect\")\r\n          .attr(\"fill\", \"#ffffff\")\r\n          .attr(\"width\", medidas.ancho)\r\n          .attr(\"height\", medidas.alto)\r\n          .style(\"filter\", \"url(#\" + idSombra + \")\");\r\n\r\n        gMarcos = gFondoListas.append(\"g\");\r\n\r\n        gListas = gFondoListas.append(\"g\");\r\n\r\n        gBoton = svg\r\n          .append(\"g\")\r\n          .attr(\r\n            \"transform\",\r\n            \"translate(\" +\r\n              (medidas.ancho - medidasBoton.ancho) / 2 +\r\n              \",\" +\r\n              (medidas.alto - medidasBoton.alto) +\r\n              \")\"\r\n          );\r\n\r\n        var offsetMarco = 0;\r\n        var gTestSVG = testSVG.append(\"g\");\r\n        gTestSVG\r\n          .append(\"rect\")\r\n          .attr(\"x\", 0)\r\n          .attr(\"y\", -20)\r\n          .attr(\"width\", medidas.ancho + margen.izquierdo + margen.derecho)\r\n          .attr(\"height\", margen.superior - offsetMarco + 20)\r\n          .attr(\"fill\", \"#ffffff\");\r\n\r\n        gTestSVG\r\n          .append(\"rect\")\r\n          .attr(\"x\", 0)\r\n          .attr(\"y\", medidas.alto + margen.inferior + offsetMarco)\r\n          .attr(\"width\", medidas.ancho + margen.izquierdo + margen.derecho)\r\n          .attr(\"height\", margen.inferior - offsetMarco + 20)\r\n          .attr(\"fill\", \"#ffffff\");\r\n\r\n        gTestSVG\r\n          .append(\"rect\")\r\n          .attr(\"x\", -20)\r\n          .attr(\"y\", 0)\r\n          .attr(\"width\", margen.izquierdo - offsetMarco + 20)\r\n          .attr(\"height\", medidas.alto + margen.superior + margen.inferior)\r\n          .attr(\"fill\", \"#ffffff\");\r\n\r\n        gTestSVG\r\n          .append(\"rect\")\r\n          .attr(\"x\", medidas.ancho + margen.derecho + offsetMarco)\r\n          .attr(\"y\", 0)\r\n          .attr(\"width\", margen.derecho - offsetMarco + 20)\r\n          .attr(\"height\", medidas.alto + margen.superior + margen.inferior)\r\n          .attr(\"fill\", \"#ffffff\");\r\n\r\n        var topes = d3.extent(_.map(palabras, \"n\"));\r\n        escalaOpacidad.domain(topes);\r\n        escalaTamanio.domain(topes);\r\n\r\n        var descarga = $(elemento)\r\n          .closest(\"div.visualizacion\")\r\n          .next()\r\n          .next()\r\n          .find(\"img[alt=download]\")\r\n          .closest(\"a\");\r\n        if (descarga.length === 0) {\r\n          descarga = $(elemento)\r\n            .closest(\"div.visualizacion\")\r\n            .closest(\"section\")\r\n            .find(\"img[alt=download]\")\r\n            .closest(\"a\");\r\n        }\r\n        if (descarga.length !== 0) {\r\n          descarga.attr(\"href\", \"#\").click(function(event) {\r\n            event.preventDefault();\r\n            event.stopPropagation();\r\n            descargaVisualizacion(elemento);\r\n          });\r\n        }\r\n\r\n        main();\r\n      }\r\n    }\r\n  }\r\n\r\n  function main() {\r\n    var q = d3.queue();\r\n    var urlValoresJSON = contenedor.attr(\"data-valores-json\") || false;\r\n    var urlCandidatos = contenedor.attr(\"data-candidatos\") || false;\r\n    if (urlCandidatos !== false && urlValoresJSON !== false) {\r\n      q.defer(d3.json, urlCandidatos + \"?\" + getGUID());\r\n      q.defer(d3.json, urlValoresJSON + \"?\" + getGUID());\r\n      q.awaitAll(function(error, arreglo) {\r\n        candidatos = arreglo[0];\r\n        var pals = arreglo[1];\r\n        var f = d3.queue();\r\n        _.each(candidatos, function(candidato) {\r\n          f.defer(convertImgToBase64URL, candidato);\r\n        });\r\n        f.awaitAll(function(error, a) {\r\n          candidatos.sort(function(a, b) {\r\n            if (a.nombrecorto < b.nombrecorto) {\r\n              return -1;\r\n            }\r\n            if (a.nombrecorto > b.nombrecorto) {\r\n              return 1;\r\n            }\r\n            return 0;\r\n          });\r\n          var anchoRetratos =\r\n            candidatos.length * retratos.ancho +\r\n            (candidatos.length - 1) * paddingRetratos;\r\n          var x = (medidas.ancho - anchoRetratos + retratos.ancho) / 2;\r\n\r\n          _.each(candidatos, function(c) {\r\n            c.coords.x = x;\r\n            c.coords.y = -220;\r\n            x += retratos.ancho + paddingRetratos;\r\n            var color = c.colorpalabras || c.color;\r\n            c.colorOriginal = c.color;\r\n            c.color = color;\r\n          });\r\n          _.each(pals, function(p) {\r\n            var candidato =\r\n              _.find(candidatos, function(c) {\r\n                return c.id === p.id;\r\n              }) || false;\r\n            if (candidato !== false) {\r\n              _.each(p.palabras, function(pal) {\r\n                var n = _.random(1, 100);\r\n                palabras.push({\r\n                  id: getGUID(),\r\n                  palabra: pal,\r\n                  n: n,\r\n                  candidato: candidato\r\n                });\r\n                palabras.push();\r\n              });\r\n            }\r\n          });\r\n          resetCandidatos();\r\n          procesaDatos();\r\n          generaBoton();\r\n          generaPalabras();\r\n          generaMarcos();\r\n          contenedor.classed(\"espera\", false);\r\n          if (flagIniciar === true) {\r\n            iniciar();\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  function iniciar() {\r\n    var num = candidatos.length;\r\n    var i = _.random(0, num - 1);\r\n    var pal = gPalabras.selectAll(\"g.etiqueta\").filter(function(d) {\r\n      return d.id === candidatos[i].id;\r\n    });\r\n    var n = pal.datum();\r\n    var xIni = n.x;\r\n    var yIni = n.y;\r\n    var xPrevio = xIni;\r\n    var yPrevio = yIni;\r\n    setCandidatoSeleccionado(n.id);\r\n    dragstart(n);\r\n    pal\r\n      .transition()\r\n      .duration(1000)\r\n      .attrTween(\"transform\", function(d) {\r\n        var xF = medidas.ancho / 2;\r\n        var yF = medidas.alto / 8;\r\n        var i = d3.interpolateString(\r\n          \"translate(\" + xIni + \",\" + yIni + \")\",\r\n          \"translate(\" + xF + \",\" + yF + \")\"\r\n        );\r\n        var j = d3.interpolateNumber(xIni, xF);\r\n        var k = d3.interpolateNumber(yIni, yF);\r\n        return function(t) {\r\n          d.px = d.x;\r\n          d.py = d.y;\r\n          d.x = j(t);\r\n          d.y = k(t);\r\n          drag(n);\r\n          return i(t);\r\n        };\r\n      })\r\n      .each(\"end\", function(d) {\r\n        d.x = medidas.ancho / 2;\r\n        d.y = medidas.alto / 8;\r\n        d.px = medidas.ancho / 2;\r\n        d.py = medidas.alto / 8;\r\n        d.weight = 10;\r\n        d.fixed = 1;\r\n        d.force = true;\r\n        dragend(d);\r\n      });\r\n  }\r\n\r\n  function clickCandidato(n) {\r\n    var pal = d3.select(this);\r\n\r\n    var xIni = n.x;\r\n    var yIni = n.y;\r\n    var xPrevio = xIni;\r\n    var yPrevio = yIni;\r\n\r\n    setCandidatoSeleccionado(n.id);\r\n    dragstart(n);\r\n    pal\r\n      .transition()\r\n      .duration(1000)\r\n      .attrTween(\"transform\", function(d) {\r\n        var xF = medidas.ancho / 2;\r\n        var yF = medidas.alto / 8;\r\n        var i = d3.interpolateString(\r\n          \"translate(\" + xIni + \",\" + yIni + \")\",\r\n          \"translate(\" + xF + \",\" + yF + \")\"\r\n        );\r\n        var j = d3.interpolateNumber(xIni, xF);\r\n        var k = d3.interpolateNumber(yIni, yF);\r\n        return function(t) {\r\n          d.px = d.x;\r\n          d.py = d.y;\r\n          d.x = j(t);\r\n          d.y = k(t);\r\n          drag(n);\r\n          return i(t);\r\n        };\r\n      })\r\n      .each(\"end\", function(d) {\r\n        d.x = medidas.ancho / 2;\r\n        d.y = medidas.alto / 8;\r\n        d.px = medidas.ancho / 2;\r\n        d.py = medidas.alto / 8;\r\n        d.weight = 10;\r\n        d.fixed = 1;\r\n        d.force = true;\r\n        dragend(d);\r\n      });\r\n  }\r\n\r\n  function resetCandidatos() {\r\n    _.each(candidatos, function(c) {\r\n      c.seleccionado = false;\r\n    });\r\n  }\r\n\r\n  function procesaDatos() {}\r\n\r\n  function getGUID() {\r\n    return (\r\n      Date.now().toString(36) +\r\n      Math.random()\r\n        .toString(36)\r\n        .substr(2, 5)\r\n    ).toUpperCase();\r\n  }\r\n\r\n  function colisiona(node) {\r\n    return function(quad, x1, y1, x2, y2) {\r\n      var updated = false;\r\n      if (\r\n        quad.point &&\r\n        quad.point !== node &&\r\n        node.principal !== true &&\r\n        quad.point.principal !== true\r\n      ) {\r\n        var x = node.x - quad.point.x;\r\n        var y = node.y - quad.point.y;\r\n        var xSpacing = (quad.point.caja.width + node.caja.width) / 2;\r\n        var ySpacing = (quad.point.caja.height + node.caja.height) / 2;\r\n        var absX = Math.abs(x);\r\n        var absY = Math.abs(y);\r\n        var l = null;\r\n        var lx = null;\r\n        var ly = null;\r\n        if (absX < xSpacing && absY < ySpacing) {\r\n          l = Math.sqrt(x * x + y * y);\r\n          lx = (absX - xSpacing) / l;\r\n          ly = (absY - ySpacing) / l;\r\n          if (Math.abs(lx) > Math.abs(ly)) {\r\n            lx = 0;\r\n          } else {\r\n            ly = 0;\r\n          }\r\n          if (node.principal !== true) {\r\n            node.x -= x *= lx;\r\n            node.y -= y *= ly;\r\n          }\r\n          if (quad.point.principal !== true) {\r\n            quad.point.x += x;\r\n            quad.point.y += y;\r\n          }\r\n\r\n          updated = true;\r\n        }\r\n      }\r\n      return updated;\r\n    };\r\n  }\r\n\r\n  function generaPalabras() {\r\n    var grupos = gPalabras\r\n      .selectAll(\"g\")\r\n      .data(candidatos)\r\n      .enter()\r\n      .append(\"g\")\r\n      .attr(\"class\", \"principal\")\r\n      .attr(\"fill\", function(d) {\r\n        return d.color;\r\n      });\r\n\r\n    _.each(candidatos, function(c) {\r\n      var nodoP = {\r\n        id: c.id,\r\n        palabra: c.nombre,\r\n        n: 200,\r\n        candidato: c,\r\n        principal: true,\r\n        fixed: true,\r\n        x: c.coords.x,\r\n        y: c.coords.y,\r\n        force: false\r\n      };\r\n      nodos.push(nodoP);\r\n      var ps = _.filter(palabras, function(p) {\r\n        return p.candidato.id === c.id;\r\n      });\r\n      _.each(ps, function(p) {\r\n        p.principal = false;\r\n        nodos.push(p);\r\n      });\r\n    });\r\n\r\n    var claves = {};\r\n    for (var i = 0; i < palabras.length; i++) {\r\n      for (var j = 0; j < palabras.length; j++) {\r\n        if (palabras[i].id !== palabras[j].id) {\r\n          var clave = [];\r\n          clave.push(palabras[i].id);\r\n          clave.push(palabras[j].id);\r\n          clave.sort();\r\n          clave = clave.join(\"-\");\r\n          var flag = claves[clave] || false;\r\n          if (flag === false) {\r\n            claves[clave] = true;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    grupos.each(function(c) {\r\n      var grupo = d3.select(this);\r\n      var ns = _.filter(nodos, function(n) {\r\n        return n.candidato.id === c.id;\r\n      });\r\n\r\n      var subgrupos = grupo\r\n        .selectAll(\"g.etiqueta\")\r\n        .data(ns, function(d) {\r\n          return d.id;\r\n        })\r\n        .enter()\r\n        .append(\"g\")\r\n        .attr(\"class\", \"etiqueta\")\r\n        .on(\"touchstart\", function(d) {\r\n          d3.event.preventDefault();\r\n        })\r\n        .on(\"touchmove\", function(d) {\r\n          d3.event.preventDefault();\r\n        })\r\n        .on(\"touchend\", function(d) {\r\n          d3.event.preventDefault();\r\n        })\r\n        .on(\"click\", function(d) {\r\n          if (!d3.event.defaultPrevented) {\r\n          }\r\n        })\r\n        .call(arrastre);\r\n\r\n      var principales = subgrupos.filter(function(d) {\r\n        return d.principal === true;\r\n      });\r\n\r\n      var secundarios = subgrupos.filter(function(d) {\r\n        return d.principal !== true;\r\n      });\r\n\r\n      principales\r\n        .append(\"svg:image\")\r\n        .attr(\"class\", \"arrastrar\")\r\n        .attr(\"fill\", function(d) {\r\n          return d.candidato.color;\r\n        })\r\n        .attr(\"width\", retratos.ancho)\r\n        .attr(\"height\", retratos.alto)\r\n        .each(function(d) {\r\n          d.caja = this.getBBox();\r\n          d.caja.width = d.caja.width + 10;\r\n          d.caja.height = d.caja.height + 10;\r\n        })\r\n        .attr(\"xlink:href\", function(d) {\r\n          return d.candidato.imgb64;\r\n        })\r\n        .attr(\r\n          \"transform\",\r\n          \"translate(\" + -retratos.ancho / 2 + \",\" + -retratos.alto / 2 + \")\"\r\n        );\r\n\r\n      secundarios.append(\"rect\").attr(\"fill\", \"transparent\");\r\n\r\n      secundarios\r\n        .append(\"text\")\r\n        .text(function(d) {\r\n          return d.palabra;\r\n        })\r\n        .style(\"font-family\", \"'Roboto', sans-serif\")\r\n        .style(\"stroke-width\", \"0\")\r\n        .style(\"fill\", function(d) {\r\n          return negros[d.orden];\r\n        })\r\n        .attr(\"text-anchor\", \"middle\")\r\n        .attr(\"dominant-baseline\", \"central\")\r\n        .style(\"font-size\", function(d, i) {\r\n          return tamanios[i] + \"px\";\r\n        })\r\n        .style(\"font-weight\", function(d, i) {\r\n          return pesos[i];\r\n        })\r\n        .each(function(d, i) {\r\n          d.orden = i;\r\n          d.caja = this.getBBox();\r\n        });\r\n\r\n      secundarios\r\n        .selectAll(\"rect\")\r\n        .attr(\"width\", function(d) {\r\n          return d.caja.width;\r\n        })\r\n        .attr(\"height\", function(d) {\r\n          return d.caja.height;\r\n        })\r\n        .attr(\"transform\", function(d) {\r\n          return (\r\n            \"translate(\" + -d.caja.width / 2 + \",\" + -d.caja.height / 2 + \")\"\r\n          );\r\n        });\r\n    });\r\n\r\n    var node = gPalabras.selectAll(\"g.etiqueta\");\r\n\r\n    force.on(\"tick\", function(e) {\r\n      var ns =\r\n        _.find(nodos, function(n) {\r\n          return n.principal === true && n.candidato.seleccionado === true;\r\n        }) || false;\r\n      if (ns !== false) {\r\n        ns.fixed = true;\r\n        var k = 2 * e.alpha;\r\n        _.each(nodos, function(n) {\r\n          if (n.candidato.id === ns.candidato.id) {\r\n            //            n.x += ns.x > n.x ? k : -k;\r\n            //n.y += ns.y > n.y ? k : -k;\r\n          } else {\r\n            n.x += ns.x < n.x ? 2 * k : 2 * -k;\r\n            n.y += ns.y < n.y ? 2 * k : 2 * -k;\r\n          }\r\n        });\r\n      }\r\n\r\n      var q = d3.geom.quadtree(nodos);\r\n      var i = 0;\r\n      while (++i < nodos.length) {\r\n        q.visit(colisiona(nodos[i]));\r\n      }\r\n\r\n      node.attr(\"transform\", function(d) {\r\n        return \"translate(\" + d.x + \",\" + d.y + \")\";\r\n      });\r\n    });\r\n\r\n    force.nodes(nodos).start();\r\n  }\r\n\r\n  function generaTooltips() {\r\n    var opciones = {\r\n      trigger: \"custom\",\r\n      triggerOpen: {\r\n        mouseenter: true,\r\n        touchstart: true\r\n      },\r\n      triggerClose: {\r\n        mouseleave: true,\r\n        tap: true\r\n      }\r\n    };\r\n    gMexico.selectAll(\"path\").each(function(d, i) {\r\n      var contenido = \"<p>\" + d.properties.datos.estado + \"</p>\";\r\n      opciones.content = $(contenido);\r\n      opciones.theme = \"tooltipster-borderless\";\r\n      $(this).tooltipster(opciones);\r\n    });\r\n  }\r\n\r\n  function setCandidatoSeleccionado(cadena) {\r\n    var c = null;\r\n    resetCandidatos();\r\n    c = _.find(candidatos, { id: cadena });\r\n    c = c || false;\r\n    if (c !== false) {\r\n      c.seleccionado = true;\r\n      candidato = c;\r\n    } else {\r\n      c = candidatoEnBlanco;\r\n    }\r\n    return c;\r\n  }\r\n\r\n  function generaBoton() {\r\n    gBoton\r\n      .append(\"rect\")\r\n      .attr(\"width\", medidasBoton.ancho)\r\n      .attr(\"height\", medidasBoton.alto)\r\n      .attr(\"fill\", \"#000000\")\r\n      .attr(\"rx\", 10)\r\n      .attr(\"ry\", 10)\r\n      .on(\"click\", toggleBoton);\r\n\r\n    var msgEsp = candidatos.length == 1 ? \"Ordenar\" : \"Ver todos\";\r\n    var msgEng = candidatos.length == 1 ? \"Sort\" : \"Show all\";\r\n\r\n    gBoton\r\n      .append(\"text\")\r\n      .text(flagEsp ? msgEsp : msgEng)\r\n      .attr(\"x\", medidasBoton.ancho / 2)\r\n      .attr(\"y\", medidasBoton.alto / 2)\r\n      .style(estiloBoton);\r\n  }\r\n\r\n  function toggleBoton() {\r\n    flagBoton = !flagBoton;\r\n    if (flagBoton === true) {\r\n      mostrarLista();\r\n    } else {\r\n      mostrarNube();\r\n    }\r\n  }\r\n\r\n  function mostrarNube() {\r\n    var msgEsp = candidatos.length == 1 ? \"Ordenar\" : \"Ver todos\";\r\n    var msgEng = candidatos.length == 1 ? \"Sort\" : \"Show all\";\r\n    quitaElementosLista();\r\n    gBoton.select(\"text\").text(flagEsp ? msgEsp : msgEng);\r\n  }\r\n\r\n  function quitaElementosLista() {\r\n    gListas\r\n      .selectAll(\".lista\")\r\n      .transition()\r\n      .duration(1000)\r\n      .attr(\"width\", retratos.ancho)\r\n      .attr(\"height\", retratos.alto)\r\n      .attr(\"transform\", function(d) {\r\n        if (d.principal === true) {\r\n          return (\r\n            \"translate(\" + -retratos.ancho / 2 + \",\" + -retratos.alto / 2 + \")\"\r\n          );\r\n        } else {\r\n          return \"translate(\" + d.x + \",\" + (d.y + medidas.alto / 2) + \")\";\r\n        }\r\n      })\r\n      .attr(\"x\", function(d) {\r\n        return d.x;\r\n      })\r\n      .attr(\"y\", function(d) {\r\n        return d.y + medidas.alto / 2;\r\n      })\r\n      .each(function(d) {\r\n        var t = d3\r\n          .select(this)\r\n          .select(\"text\")\r\n          .transition(\"testo\")\r\n          .duration(1000)\r\n          .style(\"fill\", function(dt) {\r\n            if (dt.candidato.seleccionado === true) {\r\n              return dt.candidato.color;\r\n            } else {\r\n              return negros[d.orden];\r\n            }\r\n          });\r\n      })\r\n      .call(endall, function() {\r\n        gFondoNube.attr(\"class\", \"simultaneo\").attr(\"opacity\", 1);\r\n        gFondoListas.attr(\"class\", \"ignorar simultaneo\").attr(\"opacity\", 0);\r\n        gListas.selectAll(\".lista\").remove();\r\n        force.start();\r\n      });\r\n  }\r\n\r\n  function mostrarLista() {\r\n    force.stop();\r\n    gFondoListas.attr(\"class\", \"simultaneo\").attr(\"opacity\", 1);\r\n    generaElementosLista();\r\n    gFondoNube.attr(\"class\", \"ignorar simultaneo\").attr(\"opacity\", 0);\r\n    gBoton.select(\"text\").text(flagEsp ? \"Ver nube\" : \"Show cloud\");\r\n  }\r\n\r\n  function generaMarcos() {\r\n    var ancho =\r\n      candidatos.length * marcos.ancho +\r\n      (candidatos.length - 1) * paddingMarcos;\r\n    var x = (medidas.ancho - ancho) / 2;\r\n    var grupos = gMarcos\r\n      .selectAll(\"g.marco\")\r\n      .data(candidatos)\r\n      .enter()\r\n      .append(\"g\")\r\n      .attr(\"class\", \"marco\")\r\n      .attr(\"fill\", function(d) {\r\n        return d.colorOriginal;\r\n      });\r\n\r\n    grupos\r\n      .append(\"rect\")\r\n      .attr(\"x\", function(d, i) {\r\n        d.marco = {};\r\n        d.marco.x = x;\r\n        d.marco.y = 20;\r\n        x += marcos.ancho + paddingMarcos;\r\n        return d.marco.x;\r\n      })\r\n      .attr(\"y\", function(d) {\r\n        return d.marco.y;\r\n      })\r\n      .attr(\"width\", marcos.ancho)\r\n      .attr(\"height\", 500)\r\n      .attr(\"fill\", \"#ffffff\")\r\n      .style(\"filter\", \"url(#\" + idSombra + \")\");\r\n  }\r\n\r\n  function endall(transition, callback) {\r\n    var n = 0;\r\n    transition\r\n      .each(function() {\r\n        ++n;\r\n      })\r\n      .each(\"end\", function() {\r\n        if (!--n) callback.apply(this, arguments);\r\n      });\r\n  }\r\n\r\n  function generaElementosLista() {\r\n    var palabras = [];\r\n    var candidatos = [];\r\n    gPalabras.selectAll(\"g.etiqueta\").each(function(d) {\r\n      if (d.principal === true) {\r\n        candidatos.push(d);\r\n      } else {\r\n        palabras.push(d);\r\n      }\r\n    });\r\n\r\n    var ancho =\r\n      candidatos.length * marcos.ancho +\r\n      (candidatos.length - 1) * paddingMarcos;\r\n    var x = (medidas.ancho - ancho) / 2;\r\n\r\n    gListas\r\n      .selectAll(\"image\")\r\n      .data(candidatos)\r\n      .enter()\r\n      .append(\"svg:image\")\r\n      .attr(\"class\", \"lista\")\r\n      .attr(\"width\", retratos.ancho)\r\n      .attr(\"height\", retratos.alto)\r\n      .attr(\"xlink:href\", function(d) {\r\n        return d.candidato.imgb64;\r\n      })\r\n      .attr(\r\n        \"transform\",\r\n        \"translate(\" + -retratos.ancho / 2 + \",\" + -retratos.alto / 2 + \")\"\r\n      )\r\n      .attr(\"x\", function(d) {\r\n        return d.x;\r\n      })\r\n      .attr(\"y\", function(d) {\r\n        return d.y + medidas.alto / 2;\r\n      });\r\n\r\n    var grupos = gListas\r\n      .selectAll(\"g.lista\")\r\n      .data(palabras)\r\n      .enter()\r\n      .append(\"g\")\r\n      .attr(\"class\", \"lista palabra\")\r\n      .attr(\"transform\", function(d) {\r\n        return \"translate(\" + d.x + \",\" + (d.y + medidas.alto / 2) + \")\";\r\n      });\r\n\r\n    grupos.append(\"rect\").attr(\"class\", \"fondo\");\r\n\r\n    grupos\r\n      .append(\"text\")\r\n      .attr(\"class\", \"palabra\")\r\n      .text(function(d) {\r\n        return d.palabra;\r\n      })\r\n      .style(\"font-family\", \"'Roboto', sans-serif\")\r\n      .style(\"stroke-width\", \"0\")\r\n      .style(\"fill\", function(d) {\r\n        if (d.candidato.seleccionado === true) {\r\n          return d.candidato.color;\r\n        } else {\r\n          return negros[d.orden];\r\n        }\r\n      })\r\n      .attr(\"text-anchor\", \"middle\")\r\n      .attr(\"dominant-baseline\", \"central\")\r\n      .style(\"font-size\", function(d) {\r\n        return tamanios[d.orden] + \"px\";\r\n      })\r\n      .style(\"font-weight\", function(d) {\r\n        return pesos[d.orden];\r\n      })\r\n      .call(wrap, marcos.ancho - 30);\r\n\r\n    var altura = 0;\r\n    _.each(palabras, function(d) {});\r\n\r\n    grupos.selectAll(\"text.palabra\").each(function(d) {\r\n      if (d.orden === 0) {\r\n        altura = 0;\r\n      }\r\n      d.copia = this.getBBox();\r\n      d.lista = {};\r\n      d.lista.y = altura;\r\n      altura += d.copia.height + 6;\r\n    });\r\n\r\n    var obj = {};\r\n    _.each(palabras, function(p) {\r\n      if (!obj.hasOwnProperty(p.orden)) {\r\n        obj[p.orden] = 0;\r\n      }\r\n      if (obj[p.orden] < p.copia.height) {\r\n        obj[p.orden] = p.copia.height;\r\n      }\r\n    });\r\n\r\n    altura = 0;\r\n    _.each(palabras, function(p, i) {\r\n      if (p.orden === 0) {\r\n        altura = 0;\r\n      }\r\n      p.lista.yc = altura;\r\n      altura += obj[p.orden] + 5;\r\n    });\r\n\r\n    gMarcos\r\n      .selectAll(\"rect\")\r\n      .attr(\"height\", retratosGrandes.alto + 30 + altura);\r\n\r\n    gListas\r\n      .selectAll(\".lista\")\r\n      .transition()\r\n      .duration(1000)\r\n      .attr(\"width\", retratosGrandes.ancho)\r\n      .attr(\"height\", retratosGrandes.alto)\r\n      .attr(\"transform\", function(d, i) {\r\n        if (d.principal === true) {\r\n          return (\r\n            \"translate(\" +\r\n            -retratosGrandes.ancho / 2 +\r\n            \",\" +\r\n            -retratosGrandes.alto / 2 +\r\n            \")\"\r\n          );\r\n        } else {\r\n          return (\r\n            \"translate(\" +\r\n            (d.candidato.marco.x +\r\n              (marcos.ancho - retratosGrandes.ancho) / 2 +\r\n              retratosGrandes.ancho / 2) +\r\n            \",\" +\r\n            (retratosGrandes.alto + 60 + d.lista.yc) +\r\n            \")\"\r\n          );\r\n        }\r\n      })\r\n      .attr(\"x\", function(d) {\r\n        if (d.principal === true) {\r\n          return (\r\n            d.candidato.marco.x +\r\n            (marcos.ancho - retratosGrandes.ancho) / 2 +\r\n            retratosGrandes.ancho / 2\r\n          );\r\n        } else {\r\n          return 0;\r\n        }\r\n      })\r\n      .attr(\"y\", function(d) {\r\n        if (d.principal === true) {\r\n          return d.candidato.marco.y + 10 + retratosGrandes.alto / 2;\r\n        } else {\r\n          return 0;\r\n        }\r\n      })\r\n      .each(function(d) {\r\n        var t = d3\r\n          .select(this)\r\n          .select(\"text\")\r\n          .transition(\"testo\")\r\n          .duration(1000)\r\n          .style(\"fill\", function(dt) {\r\n            return dt.candidato.color;\r\n          });\r\n      });\r\n  }\r\n\r\n  function wrap(text, width) {\r\n    text.each(function() {\r\n      var text = d3.select(this),\r\n        words = text\r\n          .text()\r\n          .split(/\\s+/)\r\n          .reverse(),\r\n        word,\r\n        line = [],\r\n        lineNumber = 0,\r\n        lineHeight = 0.9,\r\n        y = text.attr(\"y\"),\r\n        dy = parseFloat(text.attr(\"dy\") || 0),\r\n        tspan = text\r\n          .text(null)\r\n          .append(\"tspan\")\r\n          .attr(\"x\", 0)\r\n          .attr(\"y\", y)\r\n          .attr(\"dy\", dy + \"em\")\r\n          .attr(\"dominant-baseline\", \"middle\");\r\n      while ((word = words.pop())) {\r\n        ++lineNumber;\r\n        lineNumber = lineNumber > 1 ? 1 : lineNumber;\r\n        line.push(word);\r\n        tspan.text(line.join(\" \"));\r\n        if (tspan.node().getComputedTextLength() > width) {\r\n          line.pop();\r\n          tspan.text(line.join(\" \"));\r\n          line = [word];\r\n          tspan = text\r\n            .append(\"tspan\")\r\n            .attr(\"x\", 0)\r\n            .attr(\"y\", y)\r\n            .attr(\"dy\", lineNumber * lineHeight + dy + \"em\")\r\n            .attr(\"dominant-baseline\", \"middle\")\r\n            .text(word);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  function descargaVisualizacion(elemento) {\r\n    var el = $(elemento).closest(\"div.visualizacion\");\r\n    var padre = d3\r\n      .select(el[0])\r\n      .node()\r\n      .cloneNode(true);\r\n    padre = d3.select(padre);\r\n    var svg = padre.select(\"svg\");\r\n    var nombreSVG = \"trendlecciones.svg\";\r\n    var nombrePNG = \"trendlecciones-nube-de-palabras.png\";\r\n    svg.attr(\"height\", medidas.alto + margen.superior + margen.inferior);\r\n    svg.attr(\"width\", medidas.ancho + margen.izquierdo + margen.derecho);\r\n    var html = svg\r\n      .attr(\"title\", \"Trendlecciones\")\r\n      .attr(\"version\", 1.1)\r\n      .attr(\"xmlns\", \"http://www.w3.org/2000/svg\")\r\n      .attr(\"xmlns:xlink\", \"http://www.w3.org/1999/xlink\")\r\n      .node().parentNode.innerHTML;\r\n    html = unescape(encodeURIComponent(html));\r\n    var contenidoSVG = btoa(html);\r\n    var imageArtefacto = new Image();\r\n    imageArtefacto.width = medidas.ancho + margen.izquierdo + margen.derecho;\r\n    imageArtefacto.height = medidas.alto + margen.superior + margen.inferior;\r\n    imageArtefacto.onload = function() {\r\n      var canvasArtefacto = document.createElement(\"canvas\");\r\n      canvasArtefacto.width = imageArtefacto.width;\r\n      canvasArtefacto.height = imageArtefacto.height;\r\n      canvasArtefacto.getContext(\"2d\").drawImage(imageArtefacto, 0, 0);\r\n      var contenidoPNG = canvasArtefacto.toDataURL(\"image/png\");\r\n      download(contenidoPNG, nombrePNG, \"image/png\");\r\n    };\r\n    imageArtefacto.src = \"data:image/svg+xml;base64,\" + contenidoSVG;\r\n  }\r\n\r\n  function convertImgToBase64URL(d, callback) {\r\n    var img = new Image();\r\n    //img.crossOrigin = \"Anonymous\";\r\n    img.onload = function() {\r\n      var canvas = document.createElement(\"CANVAS\"),\r\n        ctx = canvas.getContext(\"2d\"),\r\n        dataURL;\r\n      canvas.height = img.height;\r\n      canvas.width = img.width;\r\n      ctx.drawImage(img, 0, 0);\r\n      dataURL = canvas.toDataURL(\"image/png\");\r\n      d.imgb64 = dataURL;\r\n      canvas = null;\r\n      callback(null, d);\r\n    };\r\n    d.img = \"img/candidatos/\" + d.img;\r\n    img.src = d.img;\r\n  }\r\n\r\n  setup(el);\r\n\r\n  return { iniciar: iniciar };\r\n};\r\n","jQuery_3_3_1(document).ready(function($) {\r\n  /*\r\n  Un arreglo para cada tipo de visualización\r\n  */\r\n  var lineasDeTiempo = [];\r\n  var mapasACartogamas = [];\r\n  var mapasABarras = [];\r\n  var nubesDePalabras = [];\r\n  var lineasDeTiempoSelector = [];\r\n\r\n  /*\r\n  Cada arreglo se llena dependiendo del atributo data-tipo-visualizacion\r\n  */\r\n  var arreglo = $(\"[data-tipo-visualizacion=lineasDeTiempo]\");\r\n  _.each(arreglo, function(e) {\r\n    lineasDeTiempo.push({ el: e, v: null, init: false });\r\n  });\r\n\r\n  arreglo = $(\"[data-tipo-visualizacion=mapaACartograma]\");\r\n  _.each(arreglo, function(e) {\r\n    mapasACartogamas.push({ el: e, v: null, init: false });\r\n  });\r\n\r\n  arreglo = $(\"[data-tipo-visualizacion=mapaABarras]\");\r\n  _.each(arreglo, function(e) {\r\n    mapasABarras.push({ el: e, v: null, init: false });\r\n  });\r\n\r\n  arreglo = $(\"[data-tipo-visualizacion=nubeDePalabras]\");\r\n  _.each(arreglo, function(e) {\r\n    nubesDePalabras.push({ el: e, v: null, init: false });\r\n  });\r\n\r\n  arreglo = $(\"[data-tipo-visualizacion=lineasDeTiempoSelector]\");\r\n  _.each(arreglo, function(e) {\r\n    lineasDeTiempoSelector.push({ el: e, v: null, init: false });\r\n  });\r\n\r\n  /*\r\n  Para cada elemento (de cada arreglo), se revisa si se encuentra visible.\r\n    Si está visible --> Se genera una visualización\r\n    Si no está visible --> Se agrega un listener para el evento scroll, y se genera la visualización cuando sea visible\r\n  */\r\n  _.each(lineasDeTiempo, function(l) {\r\n    if ($(l.el).visible()) {\r\n      if (l.init === false) {\r\n        l.init = true;\r\n        l.v = new LineaDeTiempo($, l.el, true);\r\n      }\r\n    } else {\r\n      l.v = new LineaDeTiempo($, l.el);\r\n      $(window).scroll(function() {\r\n        if ($(l.el).visible()) {\r\n          if (l.init === false) {\r\n            l.init = true;\r\n            l.v.iniciar();\r\n          }\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  _.each(mapasACartogamas, function(m) {\r\n    if ($(m.el).visible()) {\r\n      if (m.init === false) {\r\n        m.init = true;\r\n        m.v = new MapaACartograma($, m.el, true);\r\n      }\r\n    } else {\r\n      m.v = new MapaACartograma($, m.el);\r\n      $(window).scroll(function() {\r\n        if ($(m.el).visible()) {\r\n          if (m.init === false) {\r\n            m.init = true;\r\n            m.v.iniciar();\r\n          }\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  _.each(mapasABarras, function(m) {\r\n    if ($(m.el).visible()) {\r\n      if (m.init === false) {\r\n        m.init = true;\r\n        m.v = new MapaABarras($, m.el, true);\r\n      }\r\n    } else {\r\n      m.v = new MapaABarras($, m.el);\r\n      $(window).scroll(function() {\r\n        if ($(m.el).visible()) {\r\n          if (m.init === false) {\r\n            m.init = true;\r\n            m.v.iniciar();\r\n          }\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  _.each(nubesDePalabras, function(n) {\r\n    if ($(n.el).visible()) {\r\n      if (n.init === false) {\r\n        n.init = true;\r\n        n.v = new NubeDePalabras($, n.el, true);\r\n      }\r\n    } else {\r\n      n.v = new NubeDePalabras($, n.el);\r\n      $(window).scroll(function() {\r\n        if ($(n.el).visible()) {\r\n          if (n.init === false) {\r\n            n.init = true;\r\n            n.v.iniciar();\r\n          }\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  _.each(lineasDeTiempoSelector, function(l) {\r\n    if ($(l.el).visible()) {\r\n      if (l.init === false) {\r\n        l.init = true;\r\n        l.v = new LineaDeTiempoSelector($, l.el, true);\r\n      }\r\n    } else {\r\n      l.v = new LineaDeTiempoSelector($, l.el);\r\n      $(window).scroll(function() {\r\n        if ($(l.el).visible()) {\r\n          if (l.init === false) {\r\n            l.init = true;\r\n            l.v.iniciar();\r\n          }\r\n        }\r\n      });\r\n    }\r\n  });\r\n});\r\n"]}